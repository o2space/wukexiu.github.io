<!DOCTYPE html>






  


<html class="theme-next muse use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.2.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.2.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.2.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.2.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.2.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '6.2.0',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="iOS开发 宅男 π">
<meta name="keywords" content="iOS开发 宅男 π">
<meta property="og:type" content="website">
<meta property="og:title" content="打工仔-吴克修のCODE有毒">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="打工仔-吴克修のCODE有毒">
<meta property="og:description" content="iOS开发 宅男 π">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="打工仔-吴克修のCODE有毒">
<meta name="twitter:description" content="iOS开发 宅男 π">






  <link rel="canonical" href="http://yoursite.com/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>打工仔-吴克修のCODE有毒</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">打工仔-吴克修のCODE有毒</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">工作不止眼前的需求和Bug，还有诗和远方。</p>
      
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>




<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home menu-item-active">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
    <a href="/categories/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-th"></i> <br />分类</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
    <a href="/tags/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />标签</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-about">
    <a href="/about/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-user"></i> <br />关于</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />归档</a>
  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/05/11/hello-world/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="吴克修">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="打工仔-吴克修のCODE有毒">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/11/hello-world/" itemprop="url">
                  Hello World
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-05-11 10:25:23" itemprop="dateCreated datePublished" datetime="2018-05-11T10:25:23+08:00">2018-05-11</time>
            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="noopener">Deployment</a></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/01/18/ios-sdk-care/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="吴克修">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="打工仔-吴克修のCODE有毒">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/01/18/ios-sdk-care/" itemprop="url">
                  iOS SDK注意事项
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-01-18 16:03:47" itemprop="dateCreated datePublished" datetime="2017-01-18T16:03:47+08:00">2017-01-18</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-06-26 21:48:54" itemprop="dateModified" datetime="2018-06-26T21:48:54+08:00">2018-06-26</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/iOS/" itemprop="url" rel="index"><span itemprop="name">iOS</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h5 id="一、SDK中所有的类名都应该加前缀"><a href="#一、SDK中所有的类名都应该加前缀" class="headerlink" title="一、SDK中所有的类名都应该加前缀"></a>一、SDK中所有的类名都应该加前缀</h5><h5 id="二、所有Category加前缀"><a href="#二、所有Category加前缀" class="headerlink" title="二、所有Category加前缀"></a>二、所有Category加前缀</h5><h5 id="三、尽量不要引入第三方的库、如果引入要添加前缀"><a href="#三、尽量不要引入第三方的库、如果引入要添加前缀" class="headerlink" title="三、尽量不要引入第三方的库、如果引入要添加前缀"></a>三、尽量不要引入第三方的库、如果引入要添加前缀</h5><p>比如添加了NSData+Base64，可以把NSData+Base64改成NSData+KYBase64，在前面加KY或者自己公司的缩写、产品缩写</p>
<h5 id="四、所有的提供的方法有测试例子-如果有多个模块功能，可以独立接入，尽量提供每个模块的单独demo。"><a href="#四、所有的提供的方法有测试例子-如果有多个模块功能，可以独立接入，尽量提供每个模块的单独demo。" class="headerlink" title="四、所有的提供的方法有测试例子,如果有多个模块功能，可以独立接入，尽量提供每个模块的单独demo。"></a>四、所有的提供的方法有测试例子,如果有多个模块功能，可以独立接入，尽量提供每个模块的单独demo。</h5><h5 id="五、文档的完整和正确"><a href="#五、文档的完整和正确" class="headerlink" title="五、文档的完整和正确"></a>五、文档的完整和正确</h5><h5 id="六、提供debug模式，输出必要的日志，特别是错误日志，且提供处理这个错误具体步骤"><a href="#六、提供debug模式，输出必要的日志，特别是错误日志，且提供处理这个错误具体步骤" class="headerlink" title="六、提供debug模式，输出必要的日志，特别是错误日志，且提供处理这个错误具体步骤"></a>六、提供debug模式，输出必要的日志，特别是错误日志，且提供处理这个错误具体步骤</h5><p>比如用户没有配置plist里面内容，不要只提示不能获取xx，<br>而是要提示：不能获取xx、请在info.plist中添加key为xxx value为xxx。</p>
<h5 id="七、充分测试"><a href="#七、充分测试" class="headerlink" title="七、充分测试"></a>七、充分测试</h5><p>每次更改都要充分测试，完全测试</p>
<h5 id="八、提供的方法的易用性、简洁性"><a href="#八、提供的方法的易用性、简洁性" class="headerlink" title="八、提供的方法的易用性、简洁性"></a>八、提供的方法的易用性、简洁性</h5><p>方法要“望文生义”<br>实现相同的功能的时候要尽量减少用户的操作，即减少方法的调用，能不用用户调用就不要让用户调用，能不让用户操作就不要让用户操作，自己内部解决。</p>
<h5 id="九、尽量提供模拟器的支持"><a href="#九、尽量提供模拟器的支持" class="headerlink" title="九、尽量提供模拟器的支持"></a>九、尽量提供模拟器的支持</h5><p>即使调用了第三方的SDK不支持模拟器，也可以通过判断是否为模拟器环境而决定要不要调用来提供支持</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#if TARGET_IPHONE_SIMULATOR//模拟器</span><br><span class="line"></span><br><span class="line">#elif TARGET_OS_IPHONE//真机</span><br><span class="line"></span><br><span class="line">#endif</span><br></pre></td></tr></table></figure>
<h5 id="十、向下兼容"><a href="#十、向下兼容" class="headerlink" title="十、向下兼容"></a>十、向下兼容</h5><p>新版本SDK的API要兼容旧版本的API，在旧的API要加上deprecated，并提醒加入方这个是在未来某个时候是会弃用了，尽量使用新的API。</p>
<h5 id="十一、不要太频繁的更新"><a href="#十一、不要太频繁的更新" class="headerlink" title="十一、不要太频繁的更新"></a>十一、不要太频繁的更新</h5><p>如果SDK太频繁的更新，会让开发者不爽。</p>
<h5 id="十二、尽量使Andriod和iOS的接口一致"><a href="#十二、尽量使Andriod和iOS的接口一致" class="headerlink" title="十二、尽量使Andriod和iOS的接口一致"></a>十二、尽量使Andriod和iOS的接口一致</h5><p>关于iOS和Android的一些对外接口方法，宏定义，尽量相同。 有可能接入SDK的是一个人，熟悉了一套后，接入第二个平台就快点了</p>
<h5 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h5><p>如果功能非常的多，可以考虑分包。</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/12/08/ios-uibezierpath-cashapelayer/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="吴克修">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="打工仔-吴克修のCODE有毒">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/12/08/ios-uibezierpath-cashapelayer/" itemprop="url">
                  UIBezierPath和CAShapeLayer应用
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2016-12-08 00:05:19" itemprop="dateCreated datePublished" datetime="2016-12-08T00:05:19+08:00">2016-12-08</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-06-26 21:42:53" itemprop="dateModified" datetime="2018-06-26T21:42:53+08:00">2018-06-26</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/iOS/" itemprop="url" rel="index"><span itemprop="name">iOS</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>CAShapeLayer 是 CALayer 的子类，但是比 CALayer 更灵活，可以画出各种图形。</p>
<blockquote>
<p>别忘记引入QuartzCore.framework</p>
</blockquote>
<h4 id="样例"><a href="#样例" class="headerlink" title="样例"></a>样例</h4><p>在 CAShapeLayer 中，也可以像 CALayer 一样指定它的 frame 来画，就像这样：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">- (void) Demo01View&#123;</span><br><span class="line">    CAShapeLayer *layer = [CAShapeLayer layer];</span><br><span class="line">    layer.frame = CGRectMake(110, 100, 150, 100);</span><br><span class="line">    layer.backgroundColor = [UIColor redColor].CGColor;</span><br><span class="line">    [self.view.layer addSublayer:layer];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="http://upload-images.jianshu.io/upload_images/2908476-5418e131ca2b6f65.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/372" alt="Demo01View"></p>
<p>但是，CAShapeLayer 有一个神奇的属性 path 用这个属性配合上 UIBezierPath 这个类就可以达到超神的效果。  </p>
<p>UIBezierPath 顾名思义，这是用贝塞尔曲线的方式来构建一段弧线，你可以用任意条弧线来组成你想要的形状，比如，你想用它来和上面一样画一个矩形，那就可以这样子来做：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">- (void) Demo02View&#123;</span><br><span class="line">    //矩形</span><br><span class="line">    UIBezierPath *path01 = [UIBezierPath bezierPathWithRect:CGRectMake(110, 100, 150, 100)];</span><br><span class="line">    CAShapeLayer *layer01 = [CAShapeLayer layer];</span><br><span class="line">    layer01.path = path01.CGPath;</span><br><span class="line">    layer01.fillColor = [UIColor clearColor].CGColor;//填充颜色 不要使用backgroundColor属性</span><br><span class="line">    layer01.strokeColor = [UIColor blackColor].CGColor;//边框颜色</span><br><span class="line">    [self.view.layer addSublayer:layer01];</span><br><span class="line">    </span><br><span class="line">    //圆角矩形</span><br><span class="line">    UIBezierPath *path02 = [UIBezierPath bezierPathWithRoundedRect:CGRectMake(110, 235, 150, 100) cornerRadius:50];</span><br><span class="line">    CAShapeLayer *layer02 = [CAShapeLayer layer];</span><br><span class="line">    layer02.path = path02.CGPath;</span><br><span class="line">    layer02.fillColor = [UIColor clearColor].CGColor;</span><br><span class="line">    layer02.strokeColor = [UIColor blackColor].CGColor;</span><br><span class="line">    [self.view.layer addSublayer:layer02];</span><br><span class="line">    </span><br><span class="line">    //圆 顺时针</span><br><span class="line">    CGFloat radius = 60.0;//半径</span><br><span class="line">    CGFloat startAngle = 0.0;//开始角度</span><br><span class="line">    CGFloat endAngle = (M_PI * 2);//结束角度</span><br><span class="line">    UIBezierPath *path03 = [UIBezierPath bezierPathWithArcCenter:CGPointMake([UIScreen mainScreen].bounds.size.width/2.0, 430.0) radius:radius startAngle:startAngle endAngle:endAngle clockwise:YES];</span><br><span class="line">    CAShapeLayer *layer03 = [CAShapeLayer layer];</span><br><span class="line">    layer03.path = path03.CGPath;</span><br><span class="line">    layer03.fillColor = [UIColor clearColor].CGColor;</span><br><span class="line">    layer03.strokeColor = [UIColor blackColor].CGColor;</span><br><span class="line">    [self.view.layer addSublayer:layer03];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="http://upload-images.jianshu.io/upload_images/2908476-d2060b82b247db99.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/372" alt="Demo02View"></p>
<h4 id="画曲线"><a href="#画曲线" class="headerlink" title="画曲线"></a>画曲线</h4><p>贝塞尔曲线的画法是由起点、终点、控制点三个参数来画的，为了解释清楚这个点，我写了几行代码来解释它  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- (void) Demo03View&#123;</span><br><span class="line">    CGPoint startPoint = CGPointMake(50, 300);</span><br><span class="line">    CGPoint endPoint = CGPointMake(300, 300);</span><br><span class="line">    CGPoint controlPoint = CGPointMake(170, 200);</span><br><span class="line">    </span><br><span class="line">    CALayer *layer1 = [CALayer layer];</span><br><span class="line">    layer1.frame = CGRectMake(startPoint.x, startPoint.y, 5, 5);</span><br><span class="line">    layer1.backgroundColor = [UIColor redColor].CGColor;</span><br><span class="line">    </span><br><span class="line">    CALayer *layer2 = [CALayer layer];</span><br><span class="line">    layer2.frame = CGRectMake(endPoint.x, endPoint.y, 5, 5);</span><br><span class="line">    layer2.backgroundColor = [UIColor redColor].CGColor;</span><br><span class="line">    </span><br><span class="line">    CALayer *layer3 = [CALayer layer];</span><br><span class="line">    layer3.frame = CGRectMake(controlPoint.x, controlPoint.y, 5, 5);</span><br><span class="line">    layer3.backgroundColor = [UIColor redColor].CGColor;</span><br><span class="line">    </span><br><span class="line">    UIBezierPath *path = [UIBezierPath bezierPath];</span><br><span class="line">    CAShapeLayer *layer = [CAShapeLayer layer];</span><br><span class="line">    </span><br><span class="line">    [path moveToPoint:startPoint];//移动到起始点</span><br><span class="line">    [path addQuadCurveToPoint:endPoint controlPoint:controlPoint];//结束点和控制点</span><br><span class="line">    //CGPoint controlPoint1 = CGPointMake(133, 200);</span><br><span class="line">    //CGPoint controlPoint2 = CGPointMake(216, 400);</span><br><span class="line">    //[path addCurveToPoint:endPoint controlPoint1:controlPoint1 controlPoint2:controlPoint2];//使用两个控制点来画</span><br><span class="line">    </span><br><span class="line">    layer.path = path.CGPath;</span><br><span class="line">    layer.fillColor = [UIColor clearColor].CGColor;</span><br><span class="line">    layer.strokeColor = [UIColor blackColor].CGColor;</span><br><span class="line">    </span><br><span class="line">    [self.view.layer addSublayer:layer];</span><br><span class="line">    [self.view.layer addSublayer:layer1];</span><br><span class="line">    [self.view.layer addSublayer:layer2];</span><br><span class="line">    [self.view.layer addSublayer:layer3];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="http://upload-images.jianshu.io/upload_images/2908476-2be296fca41e84ef.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/372" alt="Demo03View"></p>
<h3 id="CAShapeLayer动画"><a href="#CAShapeLayer动画" class="headerlink" title="CAShapeLayer动画"></a>CAShapeLayer动画</h3><p>动画使用 strokeEnd  strokeStart  lineWidth三个属性  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">// layer是贝塞尔曲线</span><br><span class="line">// 线从开始点到结束点逐渐显示</span><br><span class="line">- (void) animation01:(CAShapeLayer *)layer&#123;</span><br><span class="line">    CABasicAnimation *animation = [CABasicAnimation animationWithKeyPath: @&quot;strokeEnd&quot;];</span><br><span class="line">    animation.fromValue = @0;</span><br><span class="line">    animation.toValue = @1;</span><br><span class="line">    animation.duration = 2.0;</span><br><span class="line">    [layer addAnimation:animation forKey:@&quot;&quot;];</span><br><span class="line">&#125;</span><br><span class="line">// 线从中间向两边逐渐显示</span><br><span class="line">- (void) animation02:(CAShapeLayer *)layer&#123;</span><br><span class="line">    layer.strokeStart = 0.5;</span><br><span class="line">    layer.strokeEnd = 0.5;</span><br><span class="line">    </span><br><span class="line">    CABasicAnimation *animation = [CABasicAnimation animationWithKeyPath:@&quot;strokeStart&quot;];</span><br><span class="line">    animation.fromValue = @0.5;</span><br><span class="line">    animation.toValue = @0;</span><br><span class="line">    animation.duration = 2.0;</span><br><span class="line">    </span><br><span class="line">    CABasicAnimation *animation2 = [CABasicAnimation animationWithKeyPath: @&quot;strokeEnd&quot;];</span><br><span class="line">    animation2.fromValue = @(0.5);</span><br><span class="line">    animation2.toValue = @1;</span><br><span class="line">    animation2.duration = 2.0;</span><br><span class="line">    </span><br><span class="line">    [layer addAnimation:animation forKey:@&quot;&quot;];</span><br><span class="line">    [layer addAnimation:animation2 forKey:@&quot;&quot;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 线条变粗</span><br><span class="line">- (void) animation03:(CAShapeLayer *)layer&#123;</span><br><span class="line">    CABasicAnimation *animation = [CABasicAnimation animationWithKeyPath: @&quot;lineWidth&quot;];</span><br><span class="line">    animation.fromValue = @1;</span><br><span class="line">    animation.toValue = @10;</span><br><span class="line">    animation.duration = 2.0;</span><br><span class="line">    [layer addAnimation:animation forKey:@&quot;&quot;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">- (void) Demo04View&#123;</span><br><span class="line">    CGSize finalSize = CGSizeMake(CGRectGetWidth(self.view.frame), 400);</span><br><span class="line">    CGFloat layerHeight = finalSize.height * 0.2;</span><br><span class="line">    CAShapeLayer *layer = [CAShapeLayer layer];</span><br><span class="line">    UIBezierPath *bezier = [UIBezierPath bezierPath];</span><br><span class="line">    [bezier moveToPoint:CGPointMake(0, finalSize.height - layerHeight)];</span><br><span class="line">    [bezier addLineToPoint:CGPointMake(0, finalSize.height - 1)];</span><br><span class="line">    [bezier addLineToPoint:CGPointMake(finalSize.width, finalSize.height - 1)];</span><br><span class="line">    [bezier addLineToPoint:CGPointMake(finalSize.width, finalSize.height - layerHeight)];</span><br><span class="line">    [bezier addQuadCurveToPoint:CGPointMake(0,finalSize.height - layerHeight) controlPoint:CGPointMake(finalSize.width / 2, (finalSize.height - layerHeight) - 40)];</span><br><span class="line">    layer.path = bezier.CGPath;</span><br><span class="line">    layer.fillColor = [UIColor blackColor].CGColor;</span><br><span class="line">    [self.view.layer addSublayer:layer];</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    //描点</span><br><span class="line">    CALayer *layer1 = [CALayer layer];</span><br><span class="line">    layer1.frame = CGRectMake(0, finalSize.height - layerHeight, 5, 5);</span><br><span class="line">    layer1.backgroundColor = [UIColor redColor].CGColor;</span><br><span class="line">    [self.view.layer addSublayer:layer1];</span><br><span class="line">    </span><br><span class="line">    CALayer *layer2 = [CALayer layer];</span><br><span class="line">    layer2.frame = CGRectMake(0, finalSize.height - 1, 5, 5);</span><br><span class="line">    layer2.backgroundColor = [UIColor redColor].CGColor;</span><br><span class="line">    [self.view.layer addSublayer:layer2];</span><br><span class="line">    </span><br><span class="line">    CALayer *layer3 = [CALayer layer];</span><br><span class="line">    layer3.frame = CGRectMake(finalSize.width-5, finalSize.height - 1, 5, 5);</span><br><span class="line">    layer3.backgroundColor = [UIColor redColor].CGColor;</span><br><span class="line">    [self.view.layer addSublayer:layer3];</span><br><span class="line">    </span><br><span class="line">    CALayer *layer4 = [CALayer layer];</span><br><span class="line">    layer4.frame = CGRectMake(finalSize.width-5, finalSize.height - layerHeight, 5, 5);</span><br><span class="line">    layer4.backgroundColor = [UIColor redColor].CGColor;</span><br><span class="line">    [self.view.layer addSublayer:layer4];</span><br><span class="line">    </span><br><span class="line">    CALayer *layer5 = [CALayer layer];</span><br><span class="line">    layer5.frame = CGRectMake(finalSize.width / 2, (finalSize.height - layerHeight) - 40, 5, 5);</span><br><span class="line">    layer5.backgroundColor = [UIColor redColor].CGColor;</span><br><span class="line">    [self.view.layer addSublayer:layer5];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="http://upload-images.jianshu.io/upload_images/2908476-704d890bd9702059.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/372" alt="Demo04View"></p>
<h3 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h3><p>微信小眼睛<br>.h文件  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#import &lt;UIKit/UIKit.h&gt;</span><br><span class="line"></span><br><span class="line">@interface WXPullView : UIView</span><br><span class="line"></span><br><span class="line">- (void)animationWith:(CGFloat)y;</span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p>.m文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line">#import &quot;WXPullView.h&quot;</span><br><span class="line"></span><br><span class="line">@interface WXPullView ()</span><br><span class="line"></span><br><span class="line">@property (strong, nonatomic) CAShapeLayer *eyeFirstLightLayer;</span><br><span class="line">@property (strong, nonatomic) CAShapeLayer *eyeSecondLightLayer;</span><br><span class="line">@property (strong, nonatomic) CAShapeLayer *eyeballLayer;</span><br><span class="line">@property (strong, nonatomic) CAShapeLayer *topEyesocketLayer;</span><br><span class="line">@property (strong, nonatomic) CAShapeLayer *bottomEyesocketLayer;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation WXPullView</span><br><span class="line"></span><br><span class="line">- (instancetype)initWithFrame:(CGRect)frame &#123;</span><br><span class="line">    self = [super initWithFrame:frame];</span><br><span class="line">    if (self) &#123;</span><br><span class="line">        [self.layer addSublayer:self.eyeFirstLightLayer];</span><br><span class="line">        [self.layer addSublayer:self.eyeSecondLightLayer];</span><br><span class="line">        [self.layer addSublayer:self.eyeballLayer];</span><br><span class="line">        [self.layer addSublayer:self.topEyesocketLayer];</span><br><span class="line">        [self.layer addSublayer:self.bottomEyesocketLayer];</span><br><span class="line">        [self setupAnimation];</span><br><span class="line">    &#125;</span><br><span class="line">    return self;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (CAShapeLayer *)eyeFirstLightLayer &#123;</span><br><span class="line">    if (!_eyeFirstLightLayer) &#123;</span><br><span class="line">        _eyeFirstLightLayer = [CAShapeLayer layer];</span><br><span class="line">        CGPoint center = CGPointMake(CGRectGetWidth(self.frame) / 2, CGRectGetHeight(self.frame) / 2);</span><br><span class="line">        UIBezierPath *path = [UIBezierPath bezierPathWithArcCenter:center radius:CGRectGetWidth(self.frame) * 0.2 startAngle:(230.f / 180.f) * M_PI endAngle:(265.f / 180.f) * M_PI clockwise:YES];</span><br><span class="line">        _eyeFirstLightLayer.borderColor = [UIColor blackColor].CGColor;</span><br><span class="line">        _eyeFirstLightLayer.lineWidth = 5.f;</span><br><span class="line">        _eyeFirstLightLayer.path = path.CGPath;</span><br><span class="line">        _eyeFirstLightLayer.fillColor = [UIColor clearColor].CGColor;</span><br><span class="line">        _eyeFirstLightLayer.strokeColor = [UIColor whiteColor].CGColor;</span><br><span class="line">    &#125;</span><br><span class="line">    return _eyeFirstLightLayer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (CAShapeLayer *)eyeSecondLightLayer &#123;</span><br><span class="line">    if (!_eyeSecondLightLayer) &#123;</span><br><span class="line">        _eyeSecondLightLayer = [CAShapeLayer layer];</span><br><span class="line">        CGPoint center = CGPointMake(CGRectGetWidth(self.frame) / 2, CGRectGetHeight(self.frame) / 2);</span><br><span class="line">        UIBezierPath *path = [UIBezierPath bezierPathWithArcCenter:center radius:CGRectGetWidth(self.frame) * 0.2 startAngle:(211.f / 180.f) * M_PI endAngle:(220.f / 180.f) * M_PI clockwise:YES];</span><br><span class="line">        _eyeSecondLightLayer.borderColor = [UIColor blackColor].CGColor;</span><br><span class="line">        _eyeSecondLightLayer.lineWidth = 5.f;</span><br><span class="line">        _eyeSecondLightLayer.path = path.CGPath;</span><br><span class="line">        _eyeSecondLightLayer.fillColor = [UIColor clearColor].CGColor;</span><br><span class="line">        _eyeSecondLightLayer.strokeColor = [UIColor whiteColor].CGColor;</span><br><span class="line">    &#125;</span><br><span class="line">    return _eyeSecondLightLayer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (CAShapeLayer *)eyeballLayer &#123;</span><br><span class="line">    if (!_eyeballLayer) &#123;</span><br><span class="line">        _eyeballLayer = [CAShapeLayer layer];</span><br><span class="line">        CGPoint center = CGPointMake(CGRectGetWidth(self.frame) / 2, CGRectGetHeight(self.frame) / 2);</span><br><span class="line">        UIBezierPath *path = [UIBezierPath bezierPathWithArcCenter:center radius:CGRectGetWidth(self.frame) * 0.3 startAngle:(0.f / 180.f) * M_PI endAngle:(360.f / 180.f) * M_PI clockwise:YES];</span><br><span class="line">        _eyeballLayer.borderColor = [UIColor blackColor].CGColor;</span><br><span class="line">        _eyeballLayer.lineWidth = 1.f;</span><br><span class="line">        _eyeballLayer.path = path.CGPath;</span><br><span class="line">        _eyeballLayer.fillColor = [UIColor clearColor].CGColor;</span><br><span class="line">        _eyeballLayer.strokeColor = [UIColor whiteColor].CGColor;</span><br><span class="line">        _eyeballLayer.anchorPoint = CGPointMake(0.5, 0.5);</span><br><span class="line">    &#125;</span><br><span class="line">    return _eyeballLayer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (CAShapeLayer *)topEyesocketLayer &#123;</span><br><span class="line">    if (!_topEyesocketLayer) &#123;</span><br><span class="line">        _topEyesocketLayer = [CAShapeLayer layer];</span><br><span class="line">        CGPoint center = CGPointMake(CGRectGetWidth(self.frame) / 2, CGRectGetHeight(self.frame) / 2);</span><br><span class="line">        UIBezierPath *path = [UIBezierPath bezierPath];</span><br><span class="line">        [path moveToPoint:CGPointMake(0, CGRectGetHeight(self.frame) / 2)];</span><br><span class="line">        [path addQuadCurveToPoint:CGPointMake(CGRectGetWidth(self.frame), CGRectGetHeight(self.frame) / 2) controlPoint:CGPointMake(CGRectGetWidth(self.frame) / 2, center.y - center.y - 20)];</span><br><span class="line">        _topEyesocketLayer.borderColor = [UIColor blackColor].CGColor;</span><br><span class="line">        _topEyesocketLayer.lineWidth = 1.f;</span><br><span class="line">        _topEyesocketLayer.path = path.CGPath;</span><br><span class="line">        _topEyesocketLayer.fillColor = [UIColor clearColor].CGColor;</span><br><span class="line">        _topEyesocketLayer.strokeColor = [UIColor whiteColor].CGColor;</span><br><span class="line">    &#125;</span><br><span class="line">    return _topEyesocketLayer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (CAShapeLayer *)bottomEyesocketLayer &#123;</span><br><span class="line">    if (!_bottomEyesocketLayer) &#123;</span><br><span class="line">        _bottomEyesocketLayer = [CAShapeLayer layer];</span><br><span class="line">        CGPoint center = CGPointMake(CGRectGetWidth(self.frame) / 2, CGRectGetHeight(self.frame) / 2);</span><br><span class="line">        UIBezierPath *path = [UIBezierPath bezierPath];</span><br><span class="line">        [path moveToPoint:CGPointMake(0, CGRectGetHeight(self.frame) / 2)];</span><br><span class="line">        [path addQuadCurveToPoint:CGPointMake(CGRectGetWidth(self.frame), CGRectGetHeight(self.frame) / 2) controlPoint:CGPointMake(CGRectGetWidth(self.frame) / 2, center.y + center.y + 20)];</span><br><span class="line">        _bottomEyesocketLayer.borderColor = [UIColor blackColor].CGColor;</span><br><span class="line">        _bottomEyesocketLayer.lineWidth = 1.f;</span><br><span class="line">        _bottomEyesocketLayer.path = path.CGPath;</span><br><span class="line">        _bottomEyesocketLayer.fillColor = [UIColor clearColor].CGColor;</span><br><span class="line">        _bottomEyesocketLayer.strokeColor = [UIColor whiteColor].CGColor;</span><br><span class="line">    &#125;</span><br><span class="line">    return _bottomEyesocketLayer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)setupAnimation &#123;</span><br><span class="line">    self.eyeFirstLightLayer.lineWidth = 0.f;</span><br><span class="line">    self.eyeSecondLightLayer.lineWidth = 0.f;</span><br><span class="line">    self.eyeballLayer.opacity = 0.f;</span><br><span class="line">    _bottomEyesocketLayer.strokeStart = 0.5f;</span><br><span class="line">    _bottomEyesocketLayer.strokeEnd = 0.5f;</span><br><span class="line">    _topEyesocketLayer.strokeStart = 0.5f;</span><br><span class="line">    _topEyesocketLayer.strokeEnd = 0.5f;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)animationWith:(CGFloat)y &#123;</span><br><span class="line">    CGFloat flag = self.frame.origin.y * 2.f - 20.f;</span><br><span class="line">    if (y &lt; flag) &#123;</span><br><span class="line">        if (self.eyeFirstLightLayer.lineWidth &lt; 5.f) &#123;</span><br><span class="line">            self.eyeFirstLightLayer.lineWidth += 1.f;</span><br><span class="line">            self.eyeSecondLightLayer.lineWidth += 1.f;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    if(y &lt; flag - 20) &#123;</span><br><span class="line">        if (self.eyeballLayer.opacity &lt;= 1.0f) &#123;</span><br><span class="line">            self.eyeballLayer.opacity += 0.1f;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    if (y &lt; flag - 40) &#123;</span><br><span class="line">        if (self.topEyesocketLayer.strokeEnd &lt; 1.f &amp;&amp; self.topEyesocketLayer.strokeStart &gt; 0.f) &#123;</span><br><span class="line">            self.topEyesocketLayer.strokeEnd += 0.1f;</span><br><span class="line">            self.topEyesocketLayer.strokeStart -= 0.1f;</span><br><span class="line">            self.bottomEyesocketLayer.strokeEnd += 0.1f;</span><br><span class="line">            self.bottomEyesocketLayer.strokeStart -= 0.1f;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    if (y &gt; flag - 40) &#123;</span><br><span class="line">        if (self.topEyesocketLayer.strokeEnd &gt; 0.5f &amp;&amp; self.topEyesocketLayer.strokeStart &lt; 0.5f) &#123;</span><br><span class="line">            self.topEyesocketLayer.strokeEnd -= 0.1f;</span><br><span class="line">            self.topEyesocketLayer.strokeStart += 0.1f;</span><br><span class="line">            self.bottomEyesocketLayer.strokeEnd -= 0.1f;</span><br><span class="line">            self.bottomEyesocketLayer.strokeStart += 0.1f;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    if (y &gt; flag - 20) &#123;</span><br><span class="line">        if (self.eyeballLayer.opacity &gt;= 0.0f) &#123;</span><br><span class="line">            self.eyeballLayer.opacity -= 0.1f;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    if (y &gt; flag) &#123;</span><br><span class="line">        if (self.eyeFirstLightLayer.lineWidth &gt; 0.f) &#123;   </span><br><span class="line">            self.eyeFirstLightLayer.lineWidth -= 1.f;</span><br><span class="line">            self.eyeSecondLightLayer.lineWidth -= 1.f;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p><img src="http://upload-images.jianshu.io/upload_images/2908476-ddbcad862b3c82ae.gif?imageMogr2/auto-orient/strip" alt="微信小眼睛WXPullView.gif"></p>
<p>彩虹进度条<br>.h文件  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#import &lt;UIKit/UIKit.h&gt;</span><br><span class="line"></span><br><span class="line">@interface RainbowProgress : UIView</span><br><span class="line"></span><br><span class="line">//Progress 高度</span><br><span class="line">@property (nonatomic,assign)CGFloat progressHeigh;</span><br><span class="line"></span><br><span class="line">//Progress Value (0~1)</span><br><span class="line">@property (nonatomic,assign)CGFloat progressValue;</span><br><span class="line"></span><br><span class="line">/** 开始动画过程 */</span><br><span class="line">- (void)startAnimating;</span><br><span class="line">/** 结束动画过程 */</span><br><span class="line">- (void)stopAnimating;</span><br></pre></td></tr></table></figure>
<p>.m文件  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line">#import &quot;RainbowProgress.h&quot;</span><br><span class="line"></span><br><span class="line">@interface RainbowProgress ()&lt;CAAnimationDelegate&gt;</span><br><span class="line"></span><br><span class="line">/** Animating */</span><br><span class="line">@property (nonatomic,assign,getter=isAnimating)BOOL animating;</span><br><span class="line"></span><br><span class="line">/** CAShapeLayer */</span><br><span class="line">@property (nonatomic,weak)CAShapeLayer *shapeMaskLayer;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation RainbowProgress</span><br><span class="line"></span><br><span class="line">#pragma mark - 将UIView默认的CALayer替换成CAGradientLayer</span><br><span class="line">+(Class)layerClass&#123;</span><br><span class="line">    return [CAGradientLayer class];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#pragma mark - 初始化方法</span><br><span class="line">- (instancetype)initWithFrame:(CGRect)frame&#123;</span><br><span class="line">    CGRect originFrame = CGRectMake(0, self.progressHeigh, [UIScreen mainScreen].bounds.size.width, 2);</span><br><span class="line">    self = [super initWithFrame:frame];</span><br><span class="line">    if (self) &#123;</span><br><span class="line">        self.frame = originFrame;</span><br><span class="line">        </span><br><span class="line">        [self setUpRainbowLayer];</span><br><span class="line">    &#125;</span><br><span class="line">    return self;</span><br><span class="line">&#125;</span><br><span class="line">-(void)setUpRainbowLayer&#123;</span><br><span class="line">    // 1、创建CAGradientLayer彩虹条颜色层，彩虹颜色当然需要数组存储</span><br><span class="line">    CAGradientLayer* gradientLayer = (CAGradientLayer*)self.layer;</span><br><span class="line">    [gradientLayer setStartPoint:CGPointMake(0, 0)];</span><br><span class="line">    [gradientLayer setEndPoint:CGPointMake(1, 0.01)];</span><br><span class="line">    //gradientLayer.locations = @[@(0.001),@(0.001),@(0.001)];</span><br><span class="line">    NSMutableArray *rainBowColors = [NSMutableArray array];</span><br><span class="line">    for (NSInteger hue = 0; hue &lt;= 360; hue += 5) &#123;</span><br><span class="line">        UIColor *color = [UIColor colorWithHue:1.0*hue/360.0</span><br><span class="line">                                    saturation:1.0</span><br><span class="line">                                    brightness:1.0</span><br><span class="line">                                         alpha:1.0];</span><br><span class="line">        [rainBowColors addObject:(id)color.CGColor];</span><br><span class="line">    &#125;</span><br><span class="line">    gradientLayer.colors = [NSArray arrayWithArray:rainBowColors];</span><br><span class="line">    </span><br><span class="line">    // 2、创建遮罩层 同时也需要贝塞尔曲线</span><br><span class="line">    UIBezierPath* shapePath = [UIBezierPath bezierPath];</span><br><span class="line">    [shapePath moveToPoint:CGPointMake(0, 0)];</span><br><span class="line">    [shapePath addLineToPoint:CGPointMake(self.bounds.size.width, 0)];</span><br><span class="line">    </span><br><span class="line">    CAShapeLayer* shapeMaskLayer = [CAShapeLayer layer];</span><br><span class="line">    </span><br><span class="line">    shapeMaskLayer.path = shapePath.CGPath;</span><br><span class="line">    shapeMaskLayer.lineWidth = 4.f;</span><br><span class="line">    shapeMaskLayer.fillColor = [UIColor clearColor].CGColor;</span><br><span class="line">    shapeMaskLayer.strokeColor = [UIColor blackColor].CGColor;</span><br><span class="line">    // 设置shapeMaskLayer的起止点初始值均为0</span><br><span class="line">    shapeMaskLayer.strokeStart = 0;</span><br><span class="line">    shapeMaskLayer.strokeEnd = 0;</span><br><span class="line">    gradientLayer.mask = shapeMaskLayer;</span><br><span class="line">    </span><br><span class="line">    self.shapeMaskLayer = shapeMaskLayer;</span><br><span class="line">     </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#pragma mark - 执行动画的过程</span><br><span class="line">-(void)performAnimation&#123;</span><br><span class="line">    // Update the colors on the model layer</span><br><span class="line">    </span><br><span class="line">    CAGradientLayer *layer = (id)[self layer];</span><br><span class="line">    NSArray *fromColors = [layer colors];</span><br><span class="line">    NSArray *toColors = [self shiftColors:fromColors];</span><br><span class="line">    [layer setColors:toColors];</span><br><span class="line">    </span><br><span class="line">    // Create an animation to slowly move the hue gradient left to right.</span><br><span class="line">    </span><br><span class="line">    CABasicAnimation *animation;</span><br><span class="line">    animation = [CABasicAnimation animationWithKeyPath:@&quot;colors&quot;];</span><br><span class="line">    [animation setFromValue:fromColors];</span><br><span class="line">    [animation setToValue:toColors];</span><br><span class="line">    [animation setDuration:0.08];                   // CALayer的color切换时间是0.08</span><br><span class="line">    [animation setRemovedOnCompletion:YES];         // 动画完成后是否要移除</span><br><span class="line">    [animation setFillMode:kCAFillModeForwards];</span><br><span class="line">    [animation setTimingFunction:[CAMediaTimingFunction functionWithName:kCAMediaTimingFunctionLinear]];</span><br><span class="line">    [animation setDelegate:self];</span><br><span class="line">    </span><br><span class="line">    // Add the animation to our layer</span><br><span class="line">    [layer addAnimation:animation forKey:@&quot;animateGradient&quot;];</span><br><span class="line">&#125;</span><br><span class="line">/*</span><br><span class="line"> 当动画在活动时间内完成或者是从层对象中移除这个代理方法会被调用，如果动画直到它的活动时间末尾没有被移除，那这个&apos;flag&apos;是true的。</span><br><span class="line"> 回调和布尔值来保证动画的循环开始并持续以及结束该动画</span><br><span class="line"> */</span><br><span class="line">- (void)animationDidStop:(CAAnimation *)animation finished:(BOOL)flag &#123;</span><br><span class="line">    // 当动画在duration时间结束前移除了，这个方法会被调用</span><br><span class="line">    // 然后就下面的if语句判断，如果isAnimation = yes，就重新执行performAnimation</span><br><span class="line">    // 在这个performAnimation中重新创建了核心动画对象，重新设置了代理</span><br><span class="line">    if ([self isAnimating]) &#123;</span><br><span class="line">        [self performAnimation];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)startAnimating &#123;</span><br><span class="line">    if (![self isAnimating]) &#123;</span><br><span class="line">        self.animating = YES;</span><br><span class="line">        [self performAnimation];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)stopAnimating &#123;</span><br><span class="line">    if ([self isAnimating]) &#123;</span><br><span class="line">        self.animating = NO;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">#pragma mark - 辅助方法：转移可变数组最后一个元素到数组的最前面</span><br><span class="line">- (NSArray *)shiftColors:(NSArray *)colors &#123;</span><br><span class="line">    // Moves the last item in the array to the front</span><br><span class="line">    // shifting all the other elements.</span><br><span class="line">    // 数组中最后一项移动到前面</span><br><span class="line">    // 转移的所有其他元素</span><br><span class="line">    NSMutableArray *mutable = [colors mutableCopy];// 将NSArray数组换成 NSMutableArray</span><br><span class="line">    id last = [mutable lastObject]; // 单独取出最后一个元素</span><br><span class="line">    [mutable removeLastObject];              // 然后将数组中的最后一个元素去除</span><br><span class="line">    [mutable insertObject:last atIndex:0];   // 然后将取出的元素插入到最前面</span><br><span class="line">    return [NSArray arrayWithArray:mutable];</span><br><span class="line">&#125;</span><br><span class="line">#pragma mark - 重写set和get方法</span><br><span class="line">// 重设进度条在父控件的高度位置</span><br><span class="line">@synthesize progressHeigh = _progressHeigh;</span><br><span class="line">-(void)setProgressHeigh:(CGFloat)progressHeigh&#123;</span><br><span class="line">    _progressHeigh = progressHeigh;</span><br><span class="line">    // 就要重新设置RainbowProgress这个自定义UIView的高度</span><br><span class="line">    CGRect frame = self.frame;</span><br><span class="line">    frame.origin.y = _progressHeigh;</span><br><span class="line">    self.frame = frame;</span><br><span class="line">&#125;</span><br><span class="line">-(CGFloat)progressHeigh&#123;</span><br><span class="line">    if (!_progressHeigh) &#123;</span><br><span class="line">        _progressHeigh = 22;</span><br><span class="line">    &#125;</span><br><span class="line">    return _progressHeigh;</span><br><span class="line">&#125;</span><br><span class="line">// 设置进度条的值</span><br><span class="line">@synthesize progressValue = _progressValue;</span><br><span class="line">-(void)setProgressValue:(CGFloat)progressValue&#123;</span><br><span class="line">    progressValue = progressValue &gt; 1 ? 1 : progressValue;</span><br><span class="line">    progressValue = progressValue &lt; 0 ? 0 : progressValue;</span><br><span class="line">    _progressValue = progressValue;</span><br><span class="line">    self.shapeMaskLayer.strokeEnd = _progressValue;</span><br><span class="line">&#125;</span><br><span class="line">-(CGFloat)progressValue&#123;</span><br><span class="line">    return _progressValue;</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p><img src="http://upload-images.jianshu.io/upload_images/2908476-37b823582db44d58.gif?imageMogr2/auto-orient/strip" alt="彩虹进度条 RainbowProgress.gif"></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/11/28/ios-networkRequest/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="吴克修">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="打工仔-吴克修のCODE有毒">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/11/28/ios-networkRequest/" itemprop="url">
                  iOS原生网络请求
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2016-11-28 22:11:25" itemprop="dateCreated datePublished" datetime="2016-11-28T22:11:25+08:00">2016-11-28</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-06-26 20:49:54" itemprop="dateModified" datetime="2018-06-26T20:49:54+08:00">2018-06-26</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/iOS/" itemprop="url" rel="index"><span itemprop="name">iOS</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="原生网络请求了解下"><a href="#原生网络请求了解下" class="headerlink" title="原生网络请求了解下"></a>原生网络请求了解下</h2><p>用多了ASIHttpRequest与AFNetWorking第三方网络框架难免对苹果底层的网络请求陌生，了解下苹果网络访问相关知识</p>
<h3 id="一、URL-Session的基本概念"><a href="#一、URL-Session的基本概念" class="headerlink" title="一、URL Session的基本概念"></a>一、URL Session的基本概念</h3><p><strong>1.三种工作模式：</strong><br>1）默认会话模式（default）：工作模式类似于原来的NSURLConnection，使用的是基于磁盘缓存的持久化策略，使用用户keychain中保存的证书进行认证授权。<br>2）瞬时会话模式（ephemeral）：该模式不使用磁盘保存任何数据。所有和会话相关的caches，证书，cookies等都被保存在RAM中，因此当程序使会话无效，这些缓存的数据就会被自动清空。<br>3）后台会话模式（background）：该模式在后台完成上传和下载，在创建Configuration对象的时候需要提供一个NSString类型的ID用于标识完成工作的后台会话。   </p>
<p><strong>2.NSURLSession支持的三种任务</strong><br>NSURLSession类支持三种类型的任务：加载数据，下载和上传。  </p>
<h3 id="二、相关的类"><a href="#二、相关的类" class="headerlink" title="二、相关的类"></a>二、相关的类</h3><p>NSURLConnection这个名字，实际上指的是一组构成Foundation框架中URL加载系统的相互关联的组件：NSURLRequest，NSURLResponse，NSURLProtocol，NSURLCache，NSHTTPCookieStorage，NSURLCredentialStorage，以及和它同名的NSURLConnection。</p>
<p>在WWDC 2013中，Apple的团队对NSURLConnection进行了重构，并推出了NSURLSession作为替代。  </p>
<p>NSURLSession也是一组相互依赖的类，它的大部分组件和NSURLConnection中的组件相同如NSURLRequest，NSURLCache等。而NSURLSession的不同之处在于，它将NSURLConnection替换为NSURLSession和NSURLSessionConfiguration，以及3个NSURLSessionTask的子类：NSURLSessionDataTask, NSURLSessionUploadTask, 和NSURLSessionDownloadTask。   </p>
<p><img src="http://upload-images.jianshu.io/upload_images/2908476-8b0db0966a807f58.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="关系图">  </p>
<p>自己简单封装的网络工具类<br><strong>.h文件</strong>  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">//  XMNetWorkHelper.h</span><br><span class="line">//  Created by 修么 on 16/11/28</span><br><span class="line">//  Copyright © 2016年 修么. All rights reserved.</span><br><span class="line">//</span><br><span class="line"></span><br><span class="line">#import &lt;Foundation/Foundation.h&gt;</span><br><span class="line">#import &lt;UIKit/UIKit.h&gt;</span><br><span class="line"></span><br><span class="line">typedef void (^XMCompletioBlock)(NSDictionary *dic, NSURLResponse *response, NSError *error);</span><br><span class="line">typedef void (^XMSuccessBlock)(NSDictionary *data);</span><br><span class="line">typedef void (^XMFailureBlock)(NSError *error);</span><br><span class="line"></span><br><span class="line">@interface XMNetWorkHelper : NSObject</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> *  get请求</span><br><span class="line"> */</span><br><span class="line">+ (void)getWithUrlString:(NSString *)url parameters:(id)parameters success:(XMSuccessBlock)successBlock failure:(XMFailureBlock)failureBlock;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * post请求</span><br><span class="line"> */</span><br><span class="line">+ (void)postWithUrlString:(NSString *)url parameters:(id)parameters success:(XMSuccessBlock)successBlock failure:(XMFailureBlock)failureBlock;</span><br></pre></td></tr></table></figure>
<p><strong>.m文件</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line">//</span><br><span class="line">//  XMNetWorkHelper.m</span><br><span class="line">//</span><br><span class="line">//  Created by 修么 on 16/11/28.</span><br><span class="line">//  Copyright © 2016年 修么. All rights reserved.</span><br><span class="line">//</span><br><span class="line"></span><br><span class="line">#import &quot;XMNetWorkHelper.h&quot;</span><br><span class="line"></span><br><span class="line">@implementation XMNetWorkHelper</span><br><span class="line"></span><br><span class="line">//GET请求</span><br><span class="line">+ (void)getWithUrlString:(NSString *)url parameters:(id)parameters success:(XMSuccessBlock)successBlock failure:(XMFailureBlock)failureBlock</span><br><span class="line">&#123;</span><br><span class="line">    NSMutableString *mutableUrl = [[NSMutableString alloc] initWithString:url];</span><br><span class="line">    if ([parameters allKeys]) &#123;</span><br><span class="line">        [mutableUrl appendString:@&quot;?&quot;];</span><br><span class="line">        for (id key in parameters) &#123;</span><br><span class="line">            NSString *value = [[parameters objectForKey:key] stringByAddingPercentEncodingWithAllowedCharacters:[NSCharacterSet URLQueryAllowedCharacterSet]];</span><br><span class="line">            [mutableUrl appendString:[NSString stringWithFormat:@&quot;%@=%@&amp;&quot;, key, value]];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    NSString *urlEnCode = [[mutableUrl substringToIndex:mutableUrl.length - 1] stringByAddingPercentEncodingWithAllowedCharacters:[NSCharacterSet URLQueryAllowedCharacterSet]];</span><br><span class="line">    NSURLRequest *urlRequest = [NSURLRequest requestWithURL:[NSURL URLWithString:urlEnCode]];</span><br><span class="line">    NSURLSession *urlSession = [NSURLSession sharedSession];</span><br><span class="line">    NSURLSessionDataTask *dataTask = [urlSession dataTaskWithRequest:urlRequest completionHandler:^(NSData * _Nullable data, NSURLResponse * _Nullable response, NSError * _Nullable error) &#123;</span><br><span class="line">        if (error) &#123;</span><br><span class="line">            failureBlock(error);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            NSDictionary *dic = [NSJSONSerialization JSONObjectWithData:data options:NSJSONReadingMutableContainers error:nil];</span><br><span class="line">            successBlock(dic);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">    [dataTask resume];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//POST请求 使用NSMutableURLRequest可以加入请求头</span><br><span class="line">+ (void)postWithUrlString:(NSString *)url parameters:(id)parameters success:(XMSuccessBlock)successBlock failure:(XMFailureBlock)failureBlock</span><br><span class="line">&#123;</span><br><span class="line">    NSURL *nsurl = [NSURL URLWithString:url];</span><br><span class="line">    NSMutableURLRequest *request = [NSMutableURLRequest requestWithURL:nsurl];</span><br><span class="line">    //如果想要设置网络超时的时间的话，可以使用下面的方法：</span><br><span class="line">    //NSMutableURLRequest *mutableRequest=[NSMutableURLRequest requestWithURL:[NSURL URLWithString:url] cachePolicy:NSURLRequestUseProtocolCachePolicy timeoutInterval:10];</span><br><span class="line">    </span><br><span class="line">    //设置请求类型</span><br><span class="line">    request.HTTPMethod = @&quot;POST&quot;;</span><br><span class="line">    </span><br><span class="line">    //将需要的信息放入请求头 随便定义了几个</span><br><span class="line">    [request setValue:@&quot;xxx&quot; forHTTPHeaderField:@&quot;Authorization&quot;];//token</span><br><span class="line">    [request setValue:@&quot;xxx&quot; forHTTPHeaderField:@&quot;Gis-Lng&quot;];//坐标 lng</span><br><span class="line">    [request setValue:@&quot;xxx&quot; forHTTPHeaderField:@&quot;Gis-Lat&quot;];//坐标 lat</span><br><span class="line">    [request setValue:@&quot;xxx&quot; forHTTPHeaderField:@&quot;Version&quot;];//版本</span><br><span class="line">    NSLog(@&quot;POST-Header:%@&quot;,request.allHTTPHeaderFields);</span><br><span class="line">    </span><br><span class="line">    //把参数放到请求体内</span><br><span class="line">    NSString *postStr = [XMNetWorkHelper parseParams:parameters];</span><br><span class="line">    request.HTTPBody = [postStr dataUsingEncoding:NSUTF8StringEncoding];</span><br><span class="line">    </span><br><span class="line">    NSURLSession *session = [NSURLSession sharedSession];</span><br><span class="line">    NSURLSessionDataTask *dataTask = [session dataTaskWithRequest:request completionHandler:^(NSData * _Nullable data, NSURLResponse * _Nullable response, NSError * _Nullable error) &#123;</span><br><span class="line">        if (error) &#123; //请求失败</span><br><span class="line">            failureBlock(error);</span><br><span class="line">        &#125; else &#123;  //请求成功</span><br><span class="line">            NSDictionary *dic = [NSJSONSerialization JSONObjectWithData:data options:NSJSONReadingMutableContainers error:nil];</span><br><span class="line">            successBlock(dic);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">    [dataTask resume];  //开始请求</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//重新封装参数 加入app相关信息</span><br><span class="line">+ (NSString *)parseParams:(NSDictionary *)params</span><br><span class="line">&#123;</span><br><span class="line">    NSMutableDictionary *parameters = [[NSMutableDictionary alloc] initWithDictionary:params];</span><br><span class="line">    [parameters setValue:@&quot;ios&quot; forKey:@&quot;client&quot;];</span><br><span class="line">    [parameters setValue:@&quot;请替换版本号&quot; forKey:@&quot;auth_version&quot;];</span><br><span class="line">    NSString* phoneModel = @&quot;获取手机型号&quot; ;</span><br><span class="line">    NSString* phoneVersion = [[UIDevice currentDevice] systemVersion];//ios系统版本号</span><br><span class="line">    NSString *system = [NSString stringWithFormat:@&quot;%@(%@)&quot;,phoneModel, phoneVersion];</span><br><span class="line">    [parameters setValue:system forKey:@&quot;system&quot;];</span><br><span class="line">    NSDate *date = [NSDate date];</span><br><span class="line">    NSTimeInterval timeinterval = [date timeIntervalSince1970];</span><br><span class="line">    [parameters setObject:[NSString stringWithFormat:@&quot;%.0lf&quot;,timeinterval] forKey:@&quot;auth_timestamp&quot;];//请求时间戳</span><br><span class="line">    NSString *devicetoken = @&quot;请替换DeviceToken&quot;;</span><br><span class="line">    [parameters setValue:devicetoken forKey:@&quot;uuid&quot;]</span><br><span class="line">    NSLog(@&quot;请求参数:%@&quot;,parameters);    </span><br><span class="line"></span><br><span class="line">    NSString *keyValueFormat;</span><br><span class="line">    NSMutableString *result = [NSMutableString new];</span><br><span class="line">    //实例化一个key枚举器用来存放dictionary的key</span><br><span class="line">   </span><br><span class="line">   //加密处理 将所有参数加密后结果当做参数传递</span><br><span class="line">   //parameters = @&#123;@&quot;i&quot;:@&quot;加密结果 抽空加入&quot;&#125;;</span><br><span class="line">   </span><br><span class="line">    NSEnumerator *keyEnum = [parameters keyEnumerator];</span><br><span class="line">    id key;</span><br><span class="line">    while (key = [keyEnum nextObject]) &#123;</span><br><span class="line">        keyValueFormat = [NSString stringWithFormat:@&quot;%@=%@&amp;&quot;, key, [params valueForKey:key]];</span><br><span class="line">        [result appendString:keyValueFormat];</span><br><span class="line">    &#125;</span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>NSURLSession文件下载</strong>  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">//下载图片</span><br><span class="line">/**</span><br><span class="line"> 该下载方式不适合大文件下载，</span><br><span class="line"> 因为该方法需要等到文件下载完毕了，</span><br><span class="line"> 才会回调completionHandler后面的block参数，</span><br><span class="line"> 然后才可以在这个block参数可以获取location(文件下载缓存的路径)、response(响应)、error(错误信息)。</span><br><span class="line"> 这样的话，对于大文件，我们就无法实时的在下载过程中获取文件的下载进度了。</span><br><span class="line"> @param imgUrl 图片地址</span><br><span class="line"> */</span><br><span class="line">- (void)downloadImgWithUrl:(NSString *)imgUrl&#123;</span><br><span class="line">    //1.创建会话对象</span><br><span class="line">    NSURLSession *session = [NSURLSession sharedSession];</span><br><span class="line">    </span><br><span class="line">    //2.请求路径</span><br><span class="line">    NSURL *url = [NSURL URLWithString:imgUrl];</span><br><span class="line">    </span><br><span class="line">    //3.创建task</span><br><span class="line">    //接受到数据之后内部会直接写入到沙盒里面</span><br><span class="line">    //completionHandler location(文件下载缓存的路径)、response(响应)、error(错误信息)</span><br><span class="line">    NSURLSessionDownloadTask *downloadTask = [session downloadTaskWithURL:url completionHandler:^(NSURL * _Nullable location, NSURLResponse * _Nullable response, NSError * _Nullable error) &#123;</span><br><span class="line">        if (error == nil) &#123;</span><br><span class="line">            //5.接受数据</span><br><span class="line">            NSLog(@&quot;%@&quot;,location);</span><br><span class="line">            </span><br><span class="line">            //5.1确定文件的全路径</span><br><span class="line">            NSString *fullPath = [[NSSearchPathForDirectoriesInDomains(NSCachesDirectory, NSUserDomainMask, YES) lastObject] stringByAppendingPathComponent:response.suggestedFilename];</span><br><span class="line">            </span><br><span class="line">            //5.2 剪切文件</span><br><span class="line">            /*</span><br><span class="line">             第一个参数：要剪切的文件在哪里</span><br><span class="line">             第二个参数：目标地址</span><br><span class="line">             第三个参数：错误信息</span><br><span class="line">             */</span><br><span class="line">            NSError *fileError;</span><br><span class="line">            [[NSFileManager defaultManager] moveItemAtURL:location toURL:[NSURL fileURLWithPath:fullPath] error:&amp;fileError];</span><br><span class="line">            //打印</span><br><span class="line">            NSLog(@&quot;%@---%@&quot;,fullPath,[NSThread currentThread]);</span><br><span class="line">            if (fileError == nil) &#123;</span><br><span class="line">                NSLog(@&quot;file save success&quot;);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                NSLog(@&quot;file save error: %@&quot;,fileError);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            NSLog(@&quot;download error:%@&quot;,error);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    //4.启动task</span><br><span class="line">    [downloadTask resume];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//下载视频</span><br><span class="line">- (void)downloadVideoWithUrl:(NSString *)videoUrl&#123;</span><br><span class="line">    //1.创建会话对象</span><br><span class="line">    NSURLSession *session = [NSURLSession sessionWithConfiguration:[NSURLSessionConfiguration defaultSessionConfiguration] delegate:self delegateQueue:[NSOperationQueue mainQueue]];</span><br><span class="line">    </span><br><span class="line">    //2.请求路径</span><br><span class="line">    NSURL *url = [NSURL URLWithString:videoUrl];</span><br><span class="line">    </span><br><span class="line">    //3.创建task</span><br><span class="line">    NSURLSessionDownloadTask *downloadTask = [session downloadTaskWithURL:url];</span><br><span class="line">    </span><br><span class="line">    //4.启动task</span><br><span class="line">    [downloadTask resume];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#pragma mark -NSURLSessionDownloadDelegate Function</span><br><span class="line">// 下载数据的过程中会调用的代理方法</span><br><span class="line">-(void)URLSession:(NSURLSession *)session downloadTask:(NSURLSessionDownloadTask *)downloadTask didWriteData:(int64_t)bytesWritten totalBytesWritten:(int64_t)totalBytesWritten totalBytesExpectedToWrite:(int64_t)totalBytesExpectedToWrite&#123;</span><br><span class="line">    NSLog(@&quot;%lf&quot;,1.0 * totalBytesWritten / totalBytesExpectedToWrite);</span><br><span class="line">&#125;</span><br><span class="line">// 重新恢复下载的代理方法</span><br><span class="line">-(void)URLSession:(NSURLSession *)session downloadTask:(NSURLSessionDownloadTask *)downloadTask</span><br><span class="line">didResumeAtOffset:(int64_t)fileOffset expectedTotalBytes:(int64_t)expectedTotalBytes&#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line">// 写入数据到本地的时候会调用的方法</span><br><span class="line">-(void)URLSession:(NSURLSession *)session downloadTask:(NSURLSessionDownloadTask *)downloadTask</span><br><span class="line">didFinishDownloadingToURL:(NSURL *)location&#123;</span><br><span class="line">    NSString* fullPath =</span><br><span class="line">    [[NSSearchPathForDirectoriesInDomains(NSCachesDirectory, NSUserDomainMask, YES) lastObject]</span><br><span class="line">     stringByAppendingPathComponent:downloadTask.response.suggestedFilename];;</span><br><span class="line">    [[NSFileManager defaultManager] moveItemAtURL:location</span><br><span class="line">                                            toURL:[NSURL fileURLWithPath:fullPath]</span><br><span class="line">                                            error:nil];</span><br><span class="line">    NSLog(@&quot;%@&quot;,fullPath);</span><br><span class="line">&#125;</span><br><span class="line">// 请求完成，错误调用的代理方法</span><br><span class="line">-(void)URLSession:(NSURLSession *)session task:(NSURLSessionTask *)task didCompleteWithError:(NSError *)error&#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>NSURLSession文件上传</strong>  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line">//第1种方式 以流的方式上传，大小理论上不受限制，但应注意时间</span><br><span class="line">-(void)uploadFileWithData:(NSData *)fileData&#123;</span><br><span class="line">    // 1.创建url 服务器上传脚本</span><br><span class="line">    NSString *urlString = @&quot;http://服务端/upload.php&quot;;</span><br><span class="line">    NSURL *url = [NSURL URLWithString:urlString];</span><br><span class="line">    </span><br><span class="line">    // 2.创建请求</span><br><span class="line">    NSMutableURLRequest *request = [NSMutableURLRequest requestWithURL:url];</span><br><span class="line">    // 文件上传使用post</span><br><span class="line">    request.HTTPMethod = @&quot;POST&quot;;</span><br><span class="line">    </span><br><span class="line">    // 3.开始上传   request的body data将被忽略，而由fromData提供</span><br><span class="line">    [[[NSURLSession sharedSession] uploadTaskWithRequest:request fromData:fileData     completionHandler:^(NSData * _Nullable data, NSURLResponse * _Nullable response, NSError * _Nullable error) &#123;</span><br><span class="line">        if (error == nil) &#123;</span><br><span class="line">            NSLog(@&quot;upload success：%@&quot;,[[NSString alloc] initWithData:data encoding:NSUTF8StringEncoding]);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            NSLog(@&quot;upload error:%@&quot;,error);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;] resume];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//第2种方式 拼接表单的方式进行上传</span><br><span class="line">- (void)uploadWithFilePath:(NSString *)filePath withfileName:(NSString *)fileName &#123;</span><br><span class="line">    // 1.创建url  服务器上传脚本</span><br><span class="line">    NSString *urlString = @&quot;http://服务器/upload.php&quot;;</span><br><span class="line">    urlString = [urlString stringByAddingPercentEncodingWithAllowedCharacters:[NSCharacterSet URLFragmentAllowedCharacterSet]];</span><br><span class="line">    NSURL *url = [NSURL URLWithString:urlString];</span><br><span class="line">    </span><br><span class="line">    // 2.创建请求</span><br><span class="line">    NSMutableURLRequest *request = [NSMutableURLRequest requestWithURL:url];</span><br><span class="line">    // 文件上传使用post</span><br><span class="line">    request.HTTPMethod = @&quot;POST&quot;;</span><br><span class="line">    </span><br><span class="line">    NSString *contentType = [NSString stringWithFormat:@&quot;multipart/form-data; boundary=%@&quot;,@&quot;boundary&quot;];</span><br><span class="line">    </span><br><span class="line">    [request setValue:contentType forHTTPHeaderField:@&quot;Content-Type&quot;];</span><br><span class="line">    // 3.拼接表单，大小受MAX_FILE_SIZE限制(2MB)  FilePath:要上传的本地文件路径  formName:表单控件名称，应于服务器一致</span><br><span class="line">    NSData* data = [self getHttpBodyWithFilePath:filePath formName:@&quot;file&quot; reName:fileName];</span><br><span class="line">    request.HTTPBody = data;</span><br><span class="line">    // 根据需要是否提供，非必须,如果不提供，session会自动计算</span><br><span class="line">    [request setValue:[NSString stringWithFormat:@&quot;%lu&quot;,data.length] forHTTPHeaderField:@&quot;Content-Length&quot;];</span><br><span class="line">    </span><br><span class="line">    // 4.1 使用dataTask</span><br><span class="line">    [[[NSURLSession sharedSession] dataTaskWithRequest:request completionHandler:^(NSData * _Nullable data, NSURLResponse * _Nullable response, NSError * _Nullable error) &#123;</span><br><span class="line">        if (error == nil) &#123;</span><br><span class="line">            NSLog(@&quot;upload success：%@&quot;,[[NSString alloc] initWithData:data encoding:NSUTF8StringEncoding]);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            NSLog(@&quot;upload error:%@&quot;,error);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;] resume];</span><br><span class="line">#if 0</span><br><span class="line">    // 4.2 开始上传 使用uploadTask   fromData:可有可无，会被忽略</span><br><span class="line">    [[[NSURLSession sharedSession] uploadTaskWithRequest:request fromData:nil     completionHandler:^(NSData * _Nullable data, NSURLResponse * _Nullable response, NSError * _Nullable error) &#123;</span><br><span class="line">        if (error == nil) &#123;</span><br><span class="line">            NSLog(@&quot;upload success：%@&quot;,[[NSString alloc] initWithData:data encoding:NSUTF8StringEncoding]);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            NSLog(@&quot;upload error:%@&quot;,error);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;] resume];</span><br><span class="line">#endif</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/// filePath:要上传的文件路径   formName：表单控件名称  reName：上传后文件名</span><br><span class="line">- (NSData *)getHttpBodyWithFilePath:(NSString *)filePath formName:(NSString *)formName reName:(NSString *)reName</span><br><span class="line">&#123;</span><br><span class="line">    NSMutableData *data = [NSMutableData data];</span><br><span class="line">    NSURLResponse *response = [self getLocalFileResponse:filePath];</span><br><span class="line">    // 文件类型：MIMEType  文件的大小：expectedContentLength  文件名字：suggestedFilename</span><br><span class="line">    NSString *fileType = response.MIMEType;</span><br><span class="line">    </span><br><span class="line">    // 如果没有传入上传后文件名称,采用本地文件名!</span><br><span class="line">    if (reName == nil) &#123;</span><br><span class="line">        reName = response.suggestedFilename;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 表单拼接</span><br><span class="line">    NSMutableString *headerStrM =[NSMutableString string];</span><br><span class="line">    [headerStrM appendFormat:@&quot;--%@\r\n&quot;,@&quot;boundary&quot;];</span><br><span class="line">    // name：表单控件名称  filename：上传文件名</span><br><span class="line">    [headerStrM appendFormat:@&quot;Content-Disposition: form-data; name=%@; filename=%@\r\n&quot;,formName,reName];</span><br><span class="line">    [headerStrM appendFormat:@&quot;Content-Type: %@\r\n\r\n&quot;,fileType];</span><br><span class="line">    [data appendData:[headerStrM dataUsingEncoding:NSUTF8StringEncoding]];</span><br><span class="line">    </span><br><span class="line">    // 文件内容</span><br><span class="line">    NSData *fileData = [NSData dataWithContentsOfFile:filePath];</span><br><span class="line">    [data appendData:fileData];</span><br><span class="line">    </span><br><span class="line">    NSMutableString *footerStrM = [NSMutableString stringWithFormat:@&quot;\r\n--%@--\r\n&quot;,@&quot;boundary&quot;];</span><br><span class="line">    [data appendData:[footerStrM  dataUsingEncoding:NSUTF8StringEncoding]];</span><br><span class="line">    //    NSLog(@&quot;dataStr=%@&quot;,[[NSString alloc] initWithData:data encoding:NSUTF8StringEncoding]);</span><br><span class="line">    return data;</span><br><span class="line">&#125;</span><br><span class="line">/// 获取响应，主要是文件类型和文件名</span><br><span class="line">- (NSURLResponse *)getLocalFileResponse:(NSString *)urlString</span><br><span class="line">&#123;</span><br><span class="line">    urlString = [urlString stringByAddingPercentEncodingWithAllowedCharacters:[NSCharacterSet URLFragmentAllowedCharacterSet]];</span><br><span class="line">    // 本地文件请求</span><br><span class="line">    NSURL *url = [NSURL fileURLWithPath:urlString];</span><br><span class="line">    NSURLRequest *request = [NSURLRequest requestWithURL:url];</span><br><span class="line">    </span><br><span class="line">    __block NSURLResponse *localResponse = nil;</span><br><span class="line">    // 使用信号量实现NSURLSession同步请求</span><br><span class="line">    dispatch_semaphore_t semaphore = dispatch_semaphore_create(0);</span><br><span class="line">    [[[NSURLSession sharedSession] dataTaskWithRequest:request completionHandler:^(NSData * _Nullable data, NSURLResponse * _Nullable response, NSError * _Nullable error) &#123;</span><br><span class="line">        localResponse = response;</span><br><span class="line">        dispatch_semaphore_signal(semaphore);</span><br><span class="line">    &#125;] resume];</span><br><span class="line">    dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);</span><br><span class="line">    return  localResponse;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>上传服务端PHP脚本</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">//以文件流的形式上传文件</span><br><span class="line">&lt;?php</span><br><span class="line">/** 二进制流生成文件</span><br><span class="line"> * $_POST 无法解释二进制流，需要用到 $GLOBALS[&apos;HTTP_RAW_POST_DATA&apos;] 或 php://input</span><br><span class="line"> * $GLOBALS[&apos;HTTP_RAW_POST_DATA&apos;] 和 php://input 都不能用于 enctype=multipart/form-data</span><br><span class="line"> * @param    String  $file   要生成的文件路径</span><br><span class="line"> * @return   boolean</span><br><span class="line"> */</span><br><span class="line">function binary_to_file($file)&#123;</span><br><span class="line">    $content = $GLOBALS[&apos;HTTP_RAW_POST_DATA&apos;];          // 需要php.ini设置</span><br><span class="line">    if(empty($content))&#123;</span><br><span class="line">        $content = file_get_contents(&apos;php://input&apos;);    // 不需要php.ini设置，内存压力小</span><br><span class="line">    &#125;</span><br><span class="line">    $ret = file_put_contents($file, $content, true);</span><br><span class="line">    return $ret;</span><br><span class="line">&#125;</span><br><span class="line">$file_dir=&quot;images/image.png&quot;;  // 固定的文件名,注意设置images文件夹权限为所有用户可读写！！！</span><br><span class="line">binary_to_file($file_dir);</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">//以表单形式上传</span><br><span class="line">&lt;?php</span><br><span class="line">header(&quot;Content-type: application/json; charset=utf-8&quot;);</span><br><span class="line">// 配置文件需要上传到服务器的路径，需要允许所有用户有可写权限，否则无法上传！</span><br><span class="line">$uploaddir = &apos;images/&apos;;</span><br><span class="line">// file表单名称，应与客户端一致</span><br><span class="line">$uploadfile = $uploaddir . basename($_FILES[&apos;file&apos;][&apos;name&apos;]);</span><br><span class="line"></span><br><span class="line">move_uploaded_file($_FILES[&apos;file&apos;][&apos;tmp_name&apos;], $uploadfile);</span><br><span class="line"></span><br><span class="line">echo json_encode($_FILES);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h3 id="三、NSURLSessionConfiguration"><a href="#三、NSURLSessionConfiguration" class="headerlink" title="三、NSURLSessionConfiguration"></a>三、NSURLSessionConfiguration</h3><p>NSURLConnection是全局性的，即它的配置对全局有效，如果有两个链接需要不同的cookies、证书这些公共资源，则NSURLConnection无法满足要求，这时NSURLSession的优势则体现出来，NSURLSession可以同过NSURLSessionConfiguration可以设置全局的网络访问属性。  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">NSURLSessionConfiguration *config = [NSURLSessionConfiguration defaultSessionConfiguration];  </span><br><span class="line">// delegateQueue：请求完成回调函数和代理函数的运行线程，如果为nil则系统自动创建一个串行队列，不影响sessionTask的运行线程  </span><br><span class="line">NSURLSession *session = [NSURLSession sessionWithConfiguration:config delegate:self delegateQueue:[NSOperationQueue mainQueue]];</span><br></pre></td></tr></table></figure>
<p>三种会话方式：  </p>
<ol>
<li>defaultSessionConfiguration：进程内会话（默认会话），类似 NSURLConnection的标准配置，用硬盘来缓存数据。  </li>
<li>ephemeralSessionConfiguration：临时的进程内会话（内存），不会将cookie、缓存储存到本地，只会放到内存中，当应用程序退出后数据也会消失,可以用于实现“秘密浏览”  </li>
<li>backgroundSessionConfiguration：建立后台会话可以在应用程序挂起，退出，崩溃的情况下运行上传和下载任务，后台另起一个线程。另外，系统会根据设备的负载程度决定分配下载的资源，因此有可能会很慢甚至超时失败。  </li>
</ol>
<p>设置一些网络属性:  </p>
<ul>
<li>HTTPAdditionalHeaders：可以设置出站请求的数据头</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">configuration.HTTPAdditionalHeaders = @&#123; </span><br><span class="line">    @&quot;Accept&quot;: @&quot;application/json&quot;,</span><br><span class="line">    @&quot;Accept-Language&quot;: @&quot;en&quot;,</span><br><span class="line">    @&quot;Authorization&quot;: authString, </span><br><span class="line">    @&quot;User-Agent&quot;: userAgentString</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>networkServiceType，设置网络服务类型  <ul>
<li>NSURLNetworkServiceTypeDefault 默认  </li>
<li>NSURLNetworkServiceTypeVoIP VoIP  </li>
<li>NSURLNetworkServiceTypeVideo 视频  </li>
<li>NSURLNetworkServiceTypeBackground 后台  </li>
<li>NSURLNetworkServiceTypeVoice 语音  </li>
</ul>
</li>
<li>allowsCellularAccess：允许蜂窝访问  </li>
<li>timeoutIntervalForRequest：请求的超时时长  </li>
<li>requestCachePolicy：缓存策略  </li>
</ul>
<blockquote>
<p>注意事项:如果是自定义会话并指定了代理，会话会对代理进行强引用,在视图控制器销毁之前，需要取消网络会话，否则会造成内存泄漏  </p>
</blockquote>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/11/26/ios-runtime/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="吴克修">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="打工仔-吴克修のCODE有毒">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/11/26/ios-runtime/" itemprop="url">
                  iOS runtime简介
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2016-11-26 19:03:20" itemprop="dateCreated datePublished" datetime="2016-11-26T19:03:20+08:00">2016-11-26</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-06-26 21:02:03" itemprop="dateModified" datetime="2018-06-26T21:02:03+08:00">2018-06-26</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/iOS/" itemprop="url" rel="index"><span itemprop="name">iOS</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="runtime是什么"><a href="#runtime是什么" class="headerlink" title="runtime是什么"></a>runtime是什么</h3><p>掌握runtime是做好iOS开发，或是深刻掌握Objective C所必需理解的东西。公司面试都喜欢问：你对runtime熟悉吗？并不是runtime在开发中经常用到，我认为它是OC最核心的部分，只有掌握好它，你才能理解其底层的原理，而不是做一个只会造轮子的码农。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">runtime是一个c和汇编写的动态库，它就像一个小小的系统，将OC和C紧密关联，这个系统主要做两件事 ：  </span><br><span class="line">1、封装C语言的结构体和函数，让开发者在运行时创建、检查或者修改类、对象和方法等等。  </span><br><span class="line">2、传递消息，找出方法的最终执行代码。</span><br></pre></td></tr></table></figure>
<p>听起来蛮抽象的，我们来点通俗的吧？没问题～～<br>我们先写一句OC的代码 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[zhangsan walkTheDog];</span><br></pre></td></tr></table></figure>
<p>那么在运行时runtime会将它转化成C语言的代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">objc_msgSend(zhangsan, @selector(walkTheDog));</span><br></pre></td></tr></table></figure>
<p>这个方法就是发送消息的方法，类似这样的方法runtime提供了很多，比如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">objc_property_t * class_copyPropertyList ( Class cls, unsigned int *outCount ); // 获取属性列表  </span><br><span class="line"></span><br><span class="line">Method * class_copyMethodList ( Class cls, unsigned int *outCount ); // 获取所有方法的数组  </span><br><span class="line"></span><br><span class="line">BOOL class_addMethod ( Class cls, SEL name, IMP imp, const char *types ); // 添加方法</span><br></pre></td></tr></table></figure>
<p>那么我们可以利用这些方法干点什么？</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1、遍历对象的属性比如，看看zhangsan的有哪些属性（身高：180、年龄：18）</span><br><span class="line"></span><br><span class="line">2、动态添加/修改属性，动态添加/修改/替换方法比如，修改zhangsan的身高为190、年龄为20，替换walkTheDog方法（变成walkTheBigDog），给他添加一个新方法（walkTheCat）等等</span><br><span class="line"></span><br><span class="line">3、动态创建类/对象/协议等等比如，创建一个新的对象：lisi</span><br><span class="line"></span><br><span class="line">4、方法拦截调用比如，给zhangsan发送一个walkTheDog消息，但是zhangsan不知道怎么walk啊（没实现该方法），那我们可以拦截下，给该方法动态添加一个实现，甚至可以讲该方法定向或者打包给lisi（其他对象），让lisi来walk。</span><br></pre></td></tr></table></figure>
<p>以上就是runtime的通俗解释，只是稍微举个例子，更多用法大家可以发挥聪明才智，举一反三。  </p>
<h4 id="方法调用流程"><a href="#方法调用流程" class="headerlink" title="方法调用流程"></a>方法调用流程</h4><p>通俗地讲，调用方法（包含实例方法和类方法）相当于給一个对象发送消息。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">所以，实际上，类本身也是一个对象（关于Class这一块就不再这里展开了）。</span><br><span class="line">当我们调用一个方法时，是这样的：  </span><br><span class="line">Instance：调用实例方法时，会到对象所属的类的方法列表中查找。  </span><br><span class="line">Class：调用类方法时，会到类的metaClass的方法列表中查找。</span><br></pre></td></tr></table></figure>
<p>下面以实例对象调用方法[blackDog walk] 为例描述方法调用的流程：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">1、编译器会把`[blackDog walk]`转化为`objc_msgSend(blackDog，SEL)`，SEL为@selector(walk)。</span><br><span class="line"></span><br><span class="line">2、Runtime会在blackDog对象所对应的Dog类的方法缓存列表里查找方法的SEL</span><br><span class="line"></span><br><span class="line">3、如果没有找到，则在Dog类的方法分发表查找方法的SEL。（类由对象isa指针指向，方法分发表即methodList）</span><br><span class="line"></span><br><span class="line">4、如果没有找到，则在其父类（设Dog类的父类为Animal类）的方法分发表里查找方法的SEL（父类由类的superClass指向）</span><br><span class="line"></span><br><span class="line">5、如果没有找到，则沿继承体系继续下去，最终到达NSObject类。</span><br><span class="line"></span><br><span class="line">6、如果在234的其中一步中找到，则定位了方法实现的入口，执行具体实现</span><br><span class="line"></span><br><span class="line">7、如果最后还是没有找到，会面临两种情况：</span><br><span class="line">&quot;(1) 如果是使用`［blackDog walk］`的方式调用方法&quot;</span><br><span class="line">&quot;(2) 使用`［blackDog performSelector:@selector(walk)］`的方式调用方法&quot;</span><br></pre></td></tr></table></figure>
<p>第一种情况编译器会报错，第二种需要到运行时才能确定对象能否接收指定的消息，这时候会进入消息转发的流程：</p>
<h4 id="消息转发流程"><a href="#消息转发流程" class="headerlink" title="消息转发流程"></a>消息转发流程</h4><p>1、动态方法解析接收到未知消息时（假设blackDog的walk方法尚未实现），<code>runtime会调用+resolveInstanceMethod:（实例方法）</code>或者<code>+resolveClassMethod:（类方法）</code><br>在该方法中，我们可以給未知消息新增一个已经实现了的方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">void walkFunc(id self, SEL _cmd) &#123; </span><br><span class="line">  //let the dog walk</span><br><span class="line">&#125;</span><br><span class="line">+ (BOOL)resolveInstanceMethod:(SEL)sel &#123;</span><br><span class="line">  NSString * selString = NSStringFromSelector(sel);</span><br><span class="line">  if ([selString isEqualToString:@&quot;walk&quot;]) &#123;</span><br><span class="line">    class_addMethod(self.class, @selector(walk), (IMP)walkFunc, &quot;@:&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">  return [super resolveInstanceMethod:sel];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2、备用接收者<br>如果以上方法没有做处理，runtime会调用<code>- (id)forwardingTargetForSelector:(SEL)aSelector</code>方法。<br>如果该方法返回了一个非nil（也不能是self）的对象，而且该对象实现了这个方法，那么这个对象就成了消息的接收者，消息就被分发到该对象。<br>适用情况：通常在对象内部使用，让内部的另外一个对象处理消息，在外面看起来就像是该对象处理了消息。<br>比如：blackDog让女朋友whiteDog来接收这个消息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- (id)forwardingTargetForSelector:(SEL)aSelector &#123;</span><br><span class="line">  NSString * selString = NSStringFromSelector(aSelector);</span><br><span class="line">  if ([selString isEqualToString:@&quot;walk&quot;]) &#123;</span><br><span class="line">    return self.whiteDog;</span><br><span class="line">  &#125;</span><br><span class="line">  return [super forwardingTargetForSelector:aSelector];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3、完整消息转发<br>在<code>- (void)forwardInvocation:(NSInvocation *)anInvocation</code>方法中选择转发消息的对象，其中anInvocation对象封装了未知消息的所有细节，并保留调用结果发送到原始调用者。<br>比如：blackDog将消息完整转发給主人dogOwner来处理<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- (void)forwardInvocation:(NSInvocation *)anInvocation&#123;</span><br><span class="line">  if ([DogOwner instancesRespondToSelector:anInvocation.selector]) &#123;</span><br><span class="line">    [anInvocation invokeWithTarget:self.dogOwner];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>4、如果在以上三个方法都没有处理未知消息，则会引发异常。</p>
<p>初学者需要更深入地学习：<br>1、基本概念：Class、Ivar、Method等等<br>2、消息转发机制<br>3、在&lt;objc/runtime.h&gt;中理解runtime提供的方法和功能<br>4、在实际开发中如何灵活运用runtime  </p>
<p>原文链接：<a href="http://www.jianshu.com/p/f493bc6a949e" target="_blank" rel="noopener">http://www.jianshu.com/p/f493bc6a949e</a></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/11/24/ios-runtime-association/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="吴克修">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="打工仔-吴克修のCODE有毒">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/11/24/ios-runtime-association/" itemprop="url">
                  iOS runtime应用：关联对象
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2016-11-24 16:16:36" itemprop="dateCreated datePublished" datetime="2016-11-24T16:16:36+08:00">2016-11-24</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-06-26 21:35:12" itemprop="dateModified" datetime="2018-06-26T21:35:12+08:00">2018-06-26</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/iOS/" itemprop="url" rel="index"><span itemprop="name">iOS</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="类添加属性"><a href="#类添加属性" class="headerlink" title="类添加属性"></a>类添加属性</h3><p><strong>问题:</strong>“如何给OC对象（如 NSArray、UIViewController等）添加一个属性，且不使用继承的情况下。”  </p>
<h4 id="类扩展、分类-关联对象-runtime"><a href="#类扩展、分类-关联对象-runtime" class="headerlink" title="类扩展、分类+关联对象(runtime)"></a>类扩展、分类+关联对象(runtime)</h4><p><strong>第一种 类扩展 （Class Extension也有人称为匿名分类）</strong>  </p>
<ul>
<li>作用：<ul>
<li>能为某个类附加额外的属性，成员变量，方法声明</li>
<li>一般的类扩展写到.m文件中</li>
<li>一般的私有属性写到类扩展</li>
</ul>
</li>
<li>使用格式：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@interface NSArray()</span><br><span class="line">//属性</span><br><span class="line">//方法</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p><strong>第二种 分类+关联对象(runtime)</strong>  </p>
<p>先介绍下分类：  </p>
<ul>
<li>分类的小括号中必须有名字  </li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@interface 类名（分类名字）</span><br><span class="line">/*方法声明*/</span><br><span class="line">@end</span><br><span class="line">@implementation 类名（分类名字）</span><br><span class="line">/*方法实现*/</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<ul>
<li>分类只能扩充方法，不能扩展属性和成员变量（如果包含成员变量会直接报错）</li>
<li>如果分类中声明了一个属性，<strong>那么分类只会生成这个属性的set、get方法声明</strong>，也就是不会有实现。</li>
<li>举例说明：如果我们分别在，类扩展与分类中添加了两个属性</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">//类别</span><br><span class="line">@interface UIViewController(My)</span><br><span class="line">@property(nonatomic,copy)NSString *mOne;</span><br><span class="line">@end</span><br><span class="line">//类扩展</span><br><span class="line">@interface UIViewController()</span><br><span class="line">@property(nonatomic,copy)NSString *mTwo;</span><br><span class="line">@end</span><br><span class="line">-(instancetype)init&#123;</span><br><span class="line">  if (self = [super init]) &#123;</span><br><span class="line">      self.mTwo = @&quot;two two&quot;;</span><br><span class="line">      self.mOne = @&quot;one one&quot;;//这行报错 崩溃</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>po self.mOne<br>error: property ‘mOne’ not found on object of type ‘UIViewController’<br>意思是说，我们所创建的对象中并没有mOne这个属性。也就是说虽然我们再类别中声明属性不会报错，但是<strong>@property并没有自动为我们设置的属性生成set、get方法</strong>。</p>
</blockquote>
<p>现在我们结合关联对象来实现<br><strong>什么是关联对象</strong><br>关联对象是指某个OC对象通过一个唯一的key连接到一个类的实例上。<br>举个例子：xiaoming是Person类的一个实例，他的dog（一个OC对象）通过一根绳子（key）被他牵着散步，这可以说xiaoming和dog是关联起来的，当然xiaoming可以牵着多个dog。<br><strong>怎样关联对象</strong><br>runtime提供給我们的方法：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">//关联对象</span><br><span class="line">void objc_setAssociatedObject(id object, const void *key, id value, objc_AssociationPolicy policy)</span><br><span class="line">//获取关联的对象</span><br><span class="line">id objc_getAssociatedObject(id object, const void *key)</span><br><span class="line">//移除关联的对象</span><br><span class="line">void objc_removeAssociatedObjects(id object)</span><br></pre></td></tr></table></figure>
<p>变量说明：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">id object：被关联的对象（如xiaoming）</span><br><span class="line">const void *key：关联的key，要求唯一</span><br><span class="line">id value：关联的对象（如dog）</span><br><span class="line">objc_AssociationPolicy policy：内存管理的策略</span><br></pre></td></tr></table></figure>
<p>objc_AssociationPolicy policy的enum值有：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">OBJC_ASSOCIATION_ASSIGN = 0, //弱引用关联对象</span><br><span class="line">//等价于@property (assign) ， @property (unsafe_unretained)</span><br><span class="line"></span><br><span class="line">OBJC_ASSOCIATION_RETAIN_NONATOMIC = 1, //强引用关联对象，且为非原子操作</span><br><span class="line">//等价于@property (strong, nonatomic)</span><br><span class="line"></span><br><span class="line">OBJC_ASSOCIATION_COPY_NONATOMIC = 3, //复制关联对象，且为非原子操作</span><br><span class="line">//等价于@property (copy, nonatomic)</span><br><span class="line"></span><br><span class="line">OBJC_ASSOCIATION_RETAIN = 01401, //强引用关联对象，且为原子操作</span><br><span class="line">//等价于@property (strong, atomic)</span><br><span class="line"></span><br><span class="line">OBJC_ASSOCIATION_COPY = 01403 //复制关联对象，且为原子操作</span><br><span class="line">等价于@property (copy, atomic)</span><br><span class="line"></span><br><span class="line">//其中，第 2 种与第 4 种、第 3 种与第 5 种关联策略的唯一差别就在于操作是否具有原子性</span><br></pre></td></tr></table></figure>
<p>当对象被释放时，会根据这个策略来决定是否释放关联的对象，当策略是RETAIN/COPY时，会释放（release）关联的对象，当是ASSIGN，将不会释放。<br>值得注意的是，我们不需要主动调用removeAssociated来接触关联的对象，如果需要解除指定的对象，可以使用setAssociatedObject置nil来实现。  </p>
<h3 id="关联对象的应用"><a href="#关联对象的应用" class="headerlink" title="关联对象的应用"></a>关联对象的应用</h3><h4 id="添加公共属性"><a href="#添加公共属性" class="headerlink" title="添加公共属性"></a>添加公共属性</h4><p>这是最常用的一个模式，通常我们会在类声明里面添加属性，但是出于某些需求（如前言描述的情况），我们需要在分类里添加一个或多个属性的话，编译器就会报错，这个问题的解决方案就是使用runtime的关联对象。<br>应用举例：<br>我们需要自定义一个tabbar，并暴露公共的属性和方法。（读者们可以思考下使用继承和分类实现的优点和不足之处）  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">@interface UITabBarController (Custom)</span><br><span class="line">@property (nonatomic, strong) MyCustomTabbar * customTabbar;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#import &quot;UITabBarController+Custom.h&quot;</span><br><span class="line">#import &lt;objc/runtime.h&gt;</span><br><span class="line">@implementation UITabBarController (Custom)</span><br><span class="line">- (void)setCustomTabbar:(MyCustomTabbar *)customTabbar &#123;</span><br><span class="line">//这里使用方法的指针地址作为唯一的key</span><br><span class="line">    objc_setAssociatedObject(self, @selector(customTabbar), customTabbar, OBJC_ASSOCIATION_RETAIN_NONATOMIC);</span><br><span class="line">&#125;</span><br><span class="line">- (MyCustomTabbar *)customTabbar &#123; </span><br><span class="line">    return objc_getAssociatedObject(self, @selector(customTabbar));</span><br><span class="line">&#125;</span><br><span class="line">//其他方法...</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p>这样，我们就可以像原生的tabbar一样使用自定义的tabbar：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[self.tabBarController.customTabbar doSomgthig];</span><br></pre></td></tr></table></figure>
<h4 id="添加私有成员变量"><a href="#添加私有成员变量" class="headerlink" title="添加私有成员变量"></a>添加私有成员变量</h4><p>有时候，需要在分类中添加不想暴露在公共声明的成员变量。应用举例：給按钮添加点击时间的回调  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">@interface UIButton (Callback)</span><br><span class="line">- (instancetype)initWithFrame:(CGRect)frame callback:(void (^)(UIButton *))callbackBlock;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">@interface UIButton ()</span><br><span class="line">@property (nonatomic, copy) void (^callbackBlock)(UIButton * button);</span><br><span class="line">@end</span><br><span class="line">@implementation UIButton (Callback)</span><br><span class="line">- (void (^)(UIButton *))callbackBlock &#123; </span><br><span class="line">  return objc_getAssociatedObject(self, @selector(callbackBlock));</span><br><span class="line">&#125;</span><br><span class="line">- (void)setCallbackBlock:(void (^)(UIButton *))callbackBlock &#123;</span><br><span class="line">  objc_setAssociatedObject(self, @selector(callbackBlock), callbackBlock, OBJC_ASSOCIATION_COPY_NONATOMIC);</span><br><span class="line">&#125;</span><br><span class="line">- (instancetype)initWithFrame:(CGRect)frame callback:(void (^)(UIButton *))callbackBlock &#123;</span><br><span class="line">  if (self = [super initWithFrame:frame]) </span><br><span class="line">  &#123;</span><br><span class="line">    self.callbackBlock = callbackBlock;</span><br><span class="line">    [self addTarget:self action:@selector(didClickAction:) forControlEvents:UIControlEventTouchUpInside];</span><br><span class="line">  &#125; return self;</span><br><span class="line">&#125;</span><br><span class="line">- (void)didClickAction:(UIButton *)button &#123;</span><br><span class="line">  self.callbackBlock(button);</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p>PS：以上代码是否会存在内存管理的问题</p>
<h4 id="关联KVO观察者"><a href="#关联KVO观察者" class="headerlink" title="关联KVO观察者"></a>关联KVO观察者</h4><p>有时候我们在分类中使用KVO，推荐使用关联的对象作为观察者，尽量避免对象观察自身。<br>此应用模式不再举例，有兴趣的读者可以自行深入研究，或者将代码贴到评论处。  </p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/11/24/ios-launch/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="吴克修">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="打工仔-吴克修のCODE有毒">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/11/24/ios-launch/" itemprop="url">
                  获取App启动页LaunchImage或LaunchScreen
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2016-11-24 14:50:58" itemprop="dateCreated datePublished" datetime="2016-11-24T14:50:58+08:00">2016-11-24</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-06-26 21:11:03" itemprop="dateModified" datetime="2018-06-26T21:11:03+08:00">2018-06-26</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/iOS/" itemprop="url" rel="index"><span itemprop="name">iOS</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>通过获取打包到App里的启动图，初始化一个UIImageView与屏幕同等大小再加载到UIWindow上来做启动延时，从而达到自定义启动动画的目的。iOS启动画面的方式目前我所知就两种：启动图和布局文件。</p>
<h3 id="启动图（LaunchImage）"><a href="#启动图（LaunchImage）" class="headerlink" title="启动图（LaunchImage）"></a>启动图（LaunchImage）</h3><p>启动图(LaunchImage)的管理其实在iOS开始中算比较简单的了 尤其是Xcode引入了xcassets之后,完全是傻瓜式的操作,有的时候我们还是需要获取Launch Image。<br>LaunchImage在APP初始化完之后会立即消失并显示APP的界面 ，但是有的时候我们不希望它这么快就消失(比如有的人希望有个过渡效果 有的人希望等某些设置或者数据加载完之后再消失) 这也很简单，我们只要自己把LaunchImage再显示出来并且置顶就OK了。<br>不过我们配置了那么多适用于不同屏幕分辨率的LaunchImage 如何获取适合于当前屏幕分辨率的LaunchImage呢?<br>普通的办法是 把所有LaunchImage加入到工程并根据屏幕分辨率来命名 比如(640_960.png 640_1136.png …) 然后在程序中用代码拼接出对应的文件名 并引用<br>但是这种办法比较原始 而且万一以后苹果又出了一些其他分辨率的设备 或者启动图发生变化的时候 又需要人工的修改工程配置 不太好 而且还需要多占一份资源(APP的容量又变大啦)  </p>
<p><strong>解决办法</strong>  </p>
<p>读取NSBundle中的设置 即可获取当前适用的LaunchImage  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">CGSize viewSize = self.window.bounds.size;</span><br><span class="line">NSString *viewOrientation = @&quot;Portrait&quot;; //横屏请设置成 @&quot;Landscape&quot;</span><br><span class="line">NSString *launchImage = nil;</span><br><span class="line">NSArray* imagesDict = [[[NSBundle mainBundle] infoDictionary] valueForKey:@&quot;UILaunchImages&quot;];</span><br><span class="line">for (NSDictionary* dict in imagesDict)</span><br><span class="line">&#123;</span><br><span class="line">    CGSize imageSize = CGSizeFromString(dict[@&quot;UILaunchImageSize&quot;]);</span><br><span class="line">    if (CGSizeEqualToSize(imageSize, viewSize) &amp;&amp; [viewOrientation isEqualToString:dict[@&quot;UILaunchImageOrientation&quot;]]) </span><br><span class="line">    &#123; </span><br><span class="line">        launchImage = dict[@&quot;UILaunchImageName&quot;]; </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">UIImageView *launchView = [[UIImageView alloc] initWithImage:[UIImage imageNamed:launchImage]];</span><br><span class="line">launchView.frame = self.window.bounds;launchView.contentMode = UIViewContentModeScaleAspectFill;</span><br><span class="line">[self.window addSubview:launchView];</span><br><span class="line">[UIView animateWithDuration:2.0f delay:0.0f options:UIViewAnimationOptionBeginFromCurrentState animations:^&#123;  </span><br><span class="line">    launchView.alpha = 0.0f; </span><br><span class="line">    launchView.layer.transform = CATransform3DScale(CATransform3DIdentity, 1.2, 1.2, 1);</span><br><span class="line">&#125; completion:^(BOOL finished) &#123;</span><br><span class="line">    [launchView removeFromSuperview];  </span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>
<h3 id="布局文件（LaunchScreen）"><a href="#布局文件（LaunchScreen）" class="headerlink" title="布局文件（LaunchScreen）"></a>布局文件（LaunchScreen）</h3><p>开发的App基本上都是支持iOS7以上了，所以没太用启动图了，Xcode 6是LaunchScreen.xib，到Xcode 7变成了LaunchScreen.storyboard，无可厚非，两者本质都是一样的。<br>如果Storyboard和Size Class玩得多同学还是喜欢布局文件作为启动图的方式吧，所以我的方式是获取LaunchScreen.storyboard里的ViewController，在把View提取出来加到UIWindow显示做动画即可。<br>这种方式的好处就是，获取大小就是屏幕的大小，而且只要你把不同屏幕的布局搞定了，系统会帮你生成好加在的启动页，这样就免去了判断和从新设置大小的麻烦，这样才是真适配嘛~  </p>
<blockquote>
<p>PS:记得给LaunchScreen.storyboard里的ViewController设置好Storyboard ID</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">UIViewController *viewController = [[UIStoryboard storyboardWithName:@&quot;LaunchScreen&quot; bundle:nil] instantiateViewControllerWithIdentifier:@&quot;LaunchScreen&quot;];</span><br><span class="line">UIView *launchView = viewController.view;</span><br><span class="line">UIWindow *mainWindow = [UIApplication sharedApplication].keyWindow;</span><br><span class="line">launchView.frame = [UIApplication sharedApplication].keyWindow.frame;</span><br><span class="line">[mainWindow addSubview:launchView];</span><br><span class="line">[UIView animateWithDuration:0.6f delay:0.5f options:UIViewAnimationOptionBeginFromCurrentState animations:^&#123;</span><br><span class="line">    launchView.alpha = 0.0f;</span><br><span class="line">    launchView.layer.transform = CATransform3DScale(CATransform3DIdentity, 1.5f, 1.5f, 1.0f);</span><br><span class="line">&#125; completion:^(BOOL finished) &#123;</span><br><span class="line">    [launchView removeFromSuperview];</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>
          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/11/22/cocoapods-use/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="吴克修">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="打工仔-吴克修のCODE有毒">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/11/22/cocoapods-use/" itemprop="url">
                  CocoaPods 略为高级使用
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2016-11-22 19:57:15" itemprop="dateCreated datePublished" datetime="2016-11-22T19:57:15+08:00">2016-11-22</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-06-26 22:13:28" itemprop="dateModified" datetime="2018-06-26T22:13:28+08:00">2018-06-26</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/CocoaPods/" itemprop="url" rel="index"><span itemprop="name">CocoaPods</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>CocoaPods功能不算太强大，但大部分时候足够好用，仅仅是最基本的样例配置，就可以满足你项目的大部分需求，但了解更多的一一些的特性，会让你更得心应手。  </p>
<p><strong>指定源</strong><br>CocoaPods支持私有 Spec 仓库的，我们可以建立自己的源，也可以使用非官方的源，只要是符合规定的都可以指定。  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">source https://github.com/[gitbub name]/Specs.git #自己或非官方</span><br><span class="line">source https://github.com/CocoaPods/Specs.git     #官方</span><br></pre></td></tr></table></figure>
<p><strong>抑制警告</strong><br>inhibit_warnings参数能够有效的抑制CocoaPods引入的第三方代码库产生的warning。<br>可以全部指定。  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">inhibit_all_warnings!</span><br></pre></td></tr></table></figure>
<p>也可以针对指定。  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pod &apos;ReactiveCocoa&apos;, &apos;~&gt; 2.4&apos;, :inhibit_warnings =&gt; true</span><br></pre></td></tr></table></figure>
<p><strong>使用git的HEAD指向的分支</strong>  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pod &apos;ISO8601DateFormatter&apos;, :head</span><br></pre></td></tr></table></figure>
<p><strong>使用 master 分支</strong>  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pod &apos;ARAnalytics/Mixpanel&apos;, :git =&gt; &apos;https://github.com/[github name]/xxx.git&apos;</span><br></pre></td></tr></table></figure>
<p><strong>指定branch</strong>  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pod &apos;Reachability&apos;, :git =&gt; &apos;https://github.com/[github name]/xxx.git&apos;, :branch =&gt; &apos;frameworks&apos;</span><br></pre></td></tr></table></figure>
<p><strong>指定tag</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pod &apos;AFNetworking&apos;, :git =&gt; &apos;https://github.com/gowalla/AFNetworking.git&apos;, :tag =&gt; &apos;0.7.0&apos;</span><br></pre></td></tr></table></figure>
<p><strong>指定commit</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pod &apos;ARTiledImageView&apos;, :git =&gt; &apos;https://github.com/dblockARTiledImageView&apos;, :commit =&gt; &apos;1a31b864d1d56b1aaed0816c10bb55cf2e078bb8&apos;</span><br></pre></td></tr></table></figure>
<p><strong>使用子库</strong></p>
<p>可以这样  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pod &apos;QueryKit/Attribute&apos;</span><br></pre></td></tr></table></figure>
<p>也可以这样指定多个子库  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pod &apos;QueryKit&apos;, :subspecs =&gt; [&apos;Attribute&apos;, &apos;QuerySet&apos;]</span><br></pre></td></tr></table></figure>
<p><strong>使用本地代码</strong><br>通过:path可以指定本地代码，不过需要确保目录包含podspec文件。  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pod &apos;AFNetworking&apos;, :path =&gt; &apos;~/Documents/AFNetworking&apos;</span><br><span class="line">#或</span><br><span class="line">pod &apos;AFNetworking&apos;, :podspec =&gt; &apos;AFNetworking.podspec&apos;</span><br></pre></td></tr></table></figure>
<p><strong>指定target的依赖库</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">target :ZipApp do  </span><br><span class="line">  pod &apos;SSZipArchive&apos;</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p><strong>排除taget</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">target &apos;Artsy Tests&apos;, :exclusive =&gt; true do  </span><br><span class="line">  pod &apos;FBSnapshotTestCase&apos;, &apos;1.4&apos;</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p><strong>指定xcodeproj</strong><br>默认会使用Podfile文件同级目录下第一个xcodeproj，但也可以指定  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">xcodeproj &apos;MyProject&apos;</span><br><span class="line">target :test do  </span><br><span class="line">  # This Pods library links with a target in another project.</span><br><span class="line">  xcodeproj &apos;TestProject&apos;</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p><strong>指定连接的target</strong><br>如果不显式指定连接的target，Pods会默认连接project的第一个target。如果需要，可以使用link_with指定连接一个或多个target  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">link_with &apos;MyApp&apos;, &apos;MyOtherApp&apos;</span><br></pre></td></tr></table></figure>
<p><strong>指定依赖库的配置文件</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pod &apos;PonyDebugger&apos;, :configuration =&gt; [&apos;Release&apos;]</span><br></pre></td></tr></table></figure>
<p><strong>指定target的配置文件</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xcodeproj &apos;TestProject&apos;, &apos;Mac App Store&apos; =&gt; :release, &apos;Test&apos; =&gt; :debug</span><br></pre></td></tr></table></figure>
<p><strong>使用Dynamic Frameworks代替Static Libraries</strong><br>通过标志use_frameworks!就可知开启这个功能。如果需要使用Swift的库，就必须加上这个标志了。  </p>
<p><strong>加快pod install/update 速度</strong><br>使用CocoaPods来添加第三方类库，无论是执行pod install还是pod updat很多时候都卡在了Analyzing dependencies不动，这是更新本地的pod spec所以文件导致的。通过–no-repo-update标志可以不更新本地pod spec索引。当然首次install不应该添加这个标志，后续修改Podfile的时候可以适当使用，加快pod速度。  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pod install --no-repo-update  </span><br><span class="line">pod update --no-repo-update</span><br></pre></td></tr></table></figure>
<p><strong>输出详细日志</strong>  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pod update --verbose</span><br></pre></td></tr></table></figure>
<p><strong>当然可以结合</strong>  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pod install --verbose --no-repo-update</span><br><span class="line">pod update --verbose --no-repo-update</span><br></pre></td></tr></table></figure>
<h4 id="XCode的Cocoapods插件"><a href="#XCode的Cocoapods插件" class="headerlink" title="XCode的Cocoapods插件"></a>XCode的Cocoapods插件</h4><p><a href="https://github.com/kattrali/cocoapods-xcode-plugin" target="_blank" rel="noopener">cocoapods-xcode-plugin</a>是一个XCode的插件，让你方便操作Cocoapods，那是相当好用的一个插件。</p>
<p><img src="http://upload-images.jianshu.io/upload_images/2908476-59d6f38dad94b85d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="XCode的Cocoapods插件.png"></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/11/18/cocoapods-createPrivatePodspec/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="吴克修">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="打工仔-吴克修のCODE有毒">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/11/18/cocoapods-createPrivatePodspec/" itemprop="url">
                  CocoaPods 创建私有库podspec
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2016-11-18 21:52:38" itemprop="dateCreated datePublished" datetime="2016-11-18T21:52:38+08:00">2016-11-18</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-06-26 22:16:39" itemprop="dateModified" datetime="2018-06-26T22:16:39+08:00">2018-06-26</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/CocoaPods/" itemprop="url" rel="index"><span itemprop="name">CocoaPods</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="简化使用流程"><a href="#简化使用流程" class="headerlink" title="简化使用流程"></a>简化使用流程</h3><p><strong>第一步 创建私有库容器</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># pod repo add [Private Repo Name] [GitHub HTTPS clone URL]</span><br><span class="line">$ pod repo add O2Specs https://github.com/[GitHub NAME]/O2Specs.git</span><br></pre></td></tr></table></figure>
<p><strong>第二步 创建Pod项目工程文件</strong><br>如果是有现有的组件项目，并且在Git的版本管理下，那么这一步就算完成了，可以直接进行下一步了<br>如果你的组件还在你冗余庞大的项目中，需要拆分出来或者需要自己从零开始创建一个组件库，那么我建议你使用Cocoapods提供的一个工具将第二步与第三步结合起来做。  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ pod lib create podTestLibrary</span><br></pre></td></tr></table></figure>
<p>之后他会问你四个问题  1.是否需要一个例子工程；  2.选择一个测试框架；  3.是否基于View测试；  4.类的前缀；<br>这4个问题的具体介绍可以去看官方文档，我这里选择的是1.yes；2.Specta/Expecta；3.yes；4.PTL。 问完这4个问题他会自动执行pod install命令创建项目并生成依赖。</p>
<p><strong>第三步 创建podspec文件</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ pod spec create PodTestLibrary https://github.com/[GitHub NAME]/PodTestLibrary.git</span><br></pre></td></tr></table></figure>
<p>执行完之后，就创建了一个podspec文件<br>下面命令为编辑完成之后使用验证命令验证一下  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ pod lib lint #验证podspec合法</span><br><span class="line">$ pod lib lint --allow-warnings #去除警告 验证podspec合法</span><br></pre></td></tr></table></figure>
<p><strong>第四步 添加你的Podspec 到你的repo</strong><br>在前面验证通过的基础上，我们接着执行命令：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ pod repo push O2Specs PodTestLibrary.podspec</span><br></pre></td></tr></table></figure>
<p>执行完，如果失败会有相对应的警告和错误提示，只要按照警告和错误的详细信息进行修改和完善即可。</p>
<p><strong>第五步 测试私有 pod</strong><br>按照平时使用 <strong>CocoaPods</strong> 的习惯，我们添加依赖库之前会先搜索一下库，让我们执行一下命令：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pod search PodTestLibrary</span><br></pre></td></tr></table></figure>
<p>创建工程项目，添加一个Podfile文件  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ pod init</span><br></pre></td></tr></table></figure>
<p>建立后修改 <strong>Podfile</strong> 文件内容如下：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">use_frameworks!</span><br><span class="line">target &apos;TestPodDemo&apos; do</span><br><span class="line">pod &apos;PodTestLibrary&apos;  #私有库</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>执行：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ pod install</span><br></pre></td></tr></table></figure>
<p>上面执行如果没有找到相关依赖库,那么在<strong>Podfile</strong>的顶部添加如下两行代码：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">source &apos;https://github.com/CocoaPods/Specs.git&apos; #官方仓库地址</span><br><span class="line">source &apos;https://github.com/[GitHub NAME]/O2Specs.git&apos; #私有仓库地址</span><br></pre></td></tr></table></figure>
<p>再次执行 pod install  </p>
<p><strong>第六步 发布稳定的依赖库版本</strong><br>前面我们提到过，我们的这个实例依赖库 <strong>PodTestLibrary</strong> 没有生成稳定的 <strong>release</strong> 版本。当我们调试完内容之后，一般都是要发布稳定版本的，更新之后再继续发布新版本。我们可以使用命令行或者在 <strong>github</strong> 页面手动生成，这里为了方便我们使用命令行，首先在终端中 <strong>cd</strong> 到之前的依赖库 <strong>PodTestLibrary</strong> 的目录中，然后输入如下命令：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ git tag &apos;0.0.1&apos;</span><br><span class="line">$ git push --tags</span><br><span class="line">$ git push origin master</span><br></pre></td></tr></table></figure>
<p>这样我们就得到了一个稳定的 <strong>release</strong> 版本 <strong>0.0.1</strong><br>这里我用的版本号是 <strong>0.0.1</strong> 基于研发版本，关于版本号的一些规范可以参考：<a href="http://semver.org/lang/zh-CN/" target="_blank" rel="noopener">语义化版本 2.0.0</a><br>对于我们的 <strong>podspec</strong> 文件，我们也需要将 s.source<br> 做一下小小的改动:  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">s.source = &#123; :git =&gt; &quot;https://github.com/[GitHub NAME]/O2View.git&quot;, :tag =&gt; version &#125;</span><br></pre></td></tr></table></figure>
<p>最后只需要再重复 push 一下我们的 <strong>podspec</strong> 就可以！</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/11/18/cocoapods-problem/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="吴克修">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="打工仔-吴克修のCODE有毒">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/11/18/cocoapods-problem/" itemprop="url">
                  CocoaPods 遇到的一些问题
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2016-11-18 16:02:49" itemprop="dateCreated datePublished" datetime="2016-11-18T16:02:49+08:00">2016-11-18</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-06-26 22:16:17" itemprop="dateModified" datetime="2018-06-26T22:16:17+08:00">2018-06-26</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/CocoaPods/" itemprop="url" rel="index"><span itemprop="name">CocoaPods</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="升级CocoaPods版本"><a href="#升级CocoaPods版本" class="headerlink" title="升级CocoaPods版本"></a>升级CocoaPods版本</h3><p>查看当前系统Cocoapods版本命令：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ pod --version</span><br></pre></td></tr></table></figure>
<p>升级Cocoapods版本命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ sudo gem update --system</span><br><span class="line">$ gem sources --remove https://rubygems.org/ </span><br><span class="line">$ gem sources -a https://ruby.taobao.org/</span><br><span class="line">$ sudo gem install cocoapods</span><br><span class="line">$ pod setup</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>特别注意</strong><br>执行sudo gem install cocoapods<br>出现错误：  </p>
</blockquote>
<p><pre>RROR:  While executing gem … (Errno::EPERM)<br>Operation not permitted - /usr/bin/xcodeproj</pre><br>估计是gem版本没有更新。执行sudo gem update –system<br>,又出现了错误  </p>
<p><pre>RROR:  While executing gem … (Errno::EPERM)<br>    Operation not permitted - /usr/bin/update_rubygems</pre><br>MAC系统升级后由于OSX的安全解决方案,所以默认路径不能安装,需要自己制定安装的路径执行这个命令就可以了解决方案：<br>第一种 自定义GEM_HOME命令行操作(未成尝试)<br><code><pre><br>$ mkdir -p $HOME/Software/ruby<br>$ export GEM_HOME=$HOME/Software/ruby<br>$ gem install cocoapods　<br>$ export PATH=$PATH:$HOME/Sofware/ruby/bin<br>$ pod –version　　<br></pre></code><br>第二种 需要自己制定安装的路径执行这个命令就可以了（试验可用）<br><code><pre><br>sudo gem install -n /usr/local/bin cocoapods –pre<br></pre></code></p>
<p><br></p>
<blockquote>
<p>备注：在使用了pod setup之后，发现好长时间都没有变化，无法从终端上获取pod setup的执行情况，这时候可以command+N新建一个窗口，通过sudo ls用管理员权限查看目录,然后.cocoapods文件夹，输入du -sh命令查看文件夹大小变化，从而确定pod setup的运行情况  </p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ gem sources --remove https://rubygems.org/ </span><br><span class="line">$ gem sources -a https://ruby.taobao.org/</span><br></pre></td></tr></table></figure>
<p>之前替换为国内的镜像的命令可能为gem sources -a <a href="http://ruby.taobao.org/" target="_blank" rel="noopener">http://ruby.taobao.org/</a>  ，现在改为gem sources -a <a href="https://ruby.taobao.org/" target="_blank" rel="noopener">https://ruby.taobao.org/</a> </p>
<p>升级结束后再次pod –version，会发现 Cocoapods 版本号高于之前的版本，升级成功了。  </p>
<h3 id="升级仓库版本"><a href="#升级仓库版本" class="headerlink" title="升级仓库版本"></a>升级仓库版本</h3><h4 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h4><p>我们在用 Cocoapods 做第三方开源库管理的时候，有时候发现  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ pod search XXX</span><br></pre></td></tr></table></figure>
<p>版本低于github上仓库的最新release版本 （注：XXX为仓库名称）</p>
<h4 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h4><p>执行  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ pod repo update</span><br></pre></td></tr></table></figure>
<p>更新本地仓库，本地仓库完成后，即可搜索到指定的第三方库</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  


          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpg"
                alt="吴克修" />
            
              <p class="site-author-name" itemprop="name">吴克修</p>
              <p class="site-description motion-element" itemprop="description">iOS开发 宅男 π</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">10</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">2</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">2</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">吴克修</span>

  

  
</div>




  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动 v3.7.1</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/theme-next/hexo-theme-next">NexT.Muse</a> v6.2.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.2.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.2.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.2.0"></script>



  



	





  





  










  





  

  

  

  

  
  

  

  

  

  

  

</body>
</html>
